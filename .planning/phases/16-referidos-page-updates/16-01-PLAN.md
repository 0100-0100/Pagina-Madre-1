---
phase: 16-referidos-page-updates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ___/accounts/views.py
  - ___/accounts/urls.py
  - ___/templates/referidos.html
  - ___/templates/partials/_referral_row.html
autonomous: true

must_haves:
  truths:
    - "Leader sees census status badge for each referred user in table"
    - "Leader can expand row to see full voting location details"
    - "Leader can select multiple referrals and trigger bulk refresh"
    - "Bulk refresh only available for non-final statuses (not ACTIVE/CANCELLED)"
    - "Checkboxes only visible for non-final statuses (ACTIVE/CANCELLED rows have no checkbox)"
    - "Filter tabs allow viewing by status category (All/Pendientes/Encontrados/Errores)"
    - "Table columns are sortable by clicking headers"
    - "Empty state shows referral link copy button"
    - "Bulk refresh respects 30-second cooldown per user (skips recently refreshed)"
  artifacts:
    - path: "___/templates/referidos.html"
      provides: "Referidos page with census columns, filters, expandable rows, bulk refresh"
      contains: "hx-post"
    - path: "___/templates/partials/_referral_row.html"
      provides: "Single referral row partial for HTMX updates"
      contains: "data-status"
    - path: "___/accounts/views.py"
      provides: "bulk_refresh_view and updated referidos_view"
      exports: ["bulk_refresh_view", "referidos_view"]
    - path: "___/accounts/urls.py"
      provides: "URL routes for bulk refresh and row polling"
      contains: "bulk-refresh"
  key_links:
    - from: "___/templates/referidos.html"
      to: "bulk_refresh_view"
      via: "HTMX form POST"
      pattern: "hx-post.*bulk-refresh"
    - from: "bulk_refresh_view"
      to: "async_task"
      via: "Django-Q2 task queue"
      pattern: "async_task.*validate_cedula"
    - from: "___/templates/partials/_referral_row.html"
      to: "refresh_cedula_user"
      via: "HTMX hx-post"
      pattern: "hx-post.*refrescar-cedula"
---

<objective>
Update referidos page to display census status for each referred user with expandable location details, filter tabs, sortable columns, and bulk refresh capability for leaders.

Purpose: Leaders need visibility into census validation status for all their referrals and ability to trigger bulk re-validation for failed/pending lookups.
Output: Enhanced referidos.html with census column, expandable rows, filter tabs, and bulk refresh form.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase-specific context
@.planning/phases/16-referidos-page-updates/16-CONTEXT.md
@.planning/phases/16-referidos-page-updates/16-RESEARCH.md

# Prior phase patterns (HTMX, RBAC, census display)
@.planning/phases/15-profile-display-refresh/15-01-SUMMARY.md
@.planning/phases/15-profile-display-refresh/15-02-SUMMARY.md

# Existing implementation files
@___/accounts/views.py
@___/accounts/decorators.py
@___/accounts/models.py
@___/templates/referidos.html
@___/templates/partials/_census_section.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update referidos_view and create row partial</name>
  <files>
    ___/accounts/views.py
    ___/templates/partials/_referral_row.html
  </files>
  <action>
Update `referidos_view` in views.py:
1. Query referrals with `prefetch_related('cedula_info')` (OneToOneField reverse access - prefetch is optional but explicit; Django auto-fetches on access anyway)
2. Add `is_leader` context variable (request.user.role == CustomUser.Role.LEADER)
3. Add `referral_url` context for empty state copy button (build from request.build_absolute_uri with referral code)

Create `___/templates/partials/_referral_row.html` partial:
1. Main row (`<tr class="referral-row" id="row-{{ referral.id }}">`) with data attributes:
   - `data-id="{{ referral.id }}"`
   - `data-status="{{ referral.cedula_info.status|default:'NONE' }}"`
   - `data-name="{{ referral.nombre_completo }}"` (for client-side sorting)
   - `data-date="{{ referral.date_joined|date:'Y-m-d' }}"` (for sorting)
2. Columns: Checkbox (if leader + can_refresh), Name, Cedula, Registration Date, Status Badge
3. Checkbox column: Only show if is_leader AND status NOT in ['ACTIVE', 'CANCELLED_DECEASED', 'CANCELLED_OTHER'] - these are final statuses that cannot be refreshed
4. Status badge using Bootstrap colors per CONTEXT.md:
   - `bg-success` for ACTIVE (Encontrado)
   - `bg-warning text-dark` with spinner for PENDING/PROCESSING (Pendiente)
   - `bg-secondary` for NOT_FOUND (No encontrado)
   - `bg-secondary` for CANCELLED_* (Cancelada)
   - `bg-danger` for ERROR/TIMEOUT/BLOCKED (Error)
5. Row is clickable to expand (onclick="toggleDetail({{ referral.id }})")
6. Chevron icon that rotates on expand

Detail row (`<tr class="detail-row" id="detail-{{ referral.id }}" style="display: none;">`):
1. colspan="5" (checkbox + 4 columns)
2. Show location fields if cedula_info.status == 'ACTIVE': departamento, municipio, puesto, direccion, mesa
3. Show error hint if ERROR/TIMEOUT/BLOCKED: "Error al consultar - intenta de nuevo mas tarde"
4. Show timestamp in user's local time using JavaScript Date API with data-utc attribute
5. Per-referral refresh button (only if leader AND status allows refresh):
   - Use existing `refresh_cedula_user` URL from Phase 15: `hx-post="{% url 'refresh_cedula_user' referral.id %}"`
   - hx-target="#row-{{ referral.id }}" to replace entire row
   - hx-swap="outerHTML"
   - hx-indicator for spinner
   - Note: This reuses the existing view that has 30-second cooldown built in

Use `{% load humanize %}` for naturaltime filter on fetched_at.
  </action>
  <verify>
Run `python ___/manage.py check` - no errors.
Manually verify partial template syntax by inspecting the file for unclosed tags.
Verify URL name exists: `python -c "from django.urls import reverse; print(reverse('refresh_cedula_user', args=[1]))"`
  </verify>
  <done>
referidos_view returns cedula_info data, _referral_row.html partial renders status badges, checkboxes only for non-final statuses, and expandable detail rows with per-referral refresh using existing Phase 15 endpoint.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create bulk refresh view, referral row view, and wire URL routes</name>
  <files>
    ___/accounts/views.py
    ___/accounts/urls.py
  </files>
  <action>
Add `bulk_refresh_view` to views.py:
1. Decorator: `@login_required` then check `request.user.role == CustomUser.Role.LEADER` (return 403 if not)
2. Accept POST with `request.POST.getlist('ids')` for selected referral IDs
3. Limit to max 10 per request (ids = ids[:10])
4. Query referrals: `CustomUser.objects.filter(id__in=ids, referred_by=request.user)`
5. For each referral:
   - Get cedula_info via getattr(referral, 'cedula_info', None)
   - Skip if cedula_info.status in ['ACTIVE', 'CANCELLED_DECEASED', 'CANCELLED_OTHER', 'PROCESSING']
   - **Cooldown check**: Skip if cedula_info.fetched_at and (timezone.now() - cedula_info.fetched_at) < timedelta(seconds=30)
   - Set status to PROCESSING, update fetched_at to timezone.now(), and save
   - Queue async_task('accounts.tasks.validate_cedula', referral.id, 1)
   - Increment refreshed counter
6. Return partial response with HX-Trigger for toast:
   - If refreshed > 0: `{"showToast": {"message": "{N} cedulas en actualizacion", "type": "info"}}`
   - If all skipped due to cooldown: `{"showToast": {"message": "Todas las cedulas seleccionadas fueron actualizadas recientemente", "type": "warning"}}`
7. Return empty response if no IDs selected (with warning toast)

Add `referral_row_view` to views.py (for HTMX row updates after individual refresh):
1. Decorator: `@login_required`
2. Accept `referral_id` parameter via URL
3. RBAC check: Verify request.user.role == CustomUser.Role.LEADER
4. Query: `referral = get_object_or_404(CustomUser, id=referral_id, referred_by=request.user)`
5. Context: Pass `referral`, `is_leader=True`
6. Return `render(request, 'partials/_referral_row.html', context)`

Update urls.py:
1. Add `path('bulk-refresh/', bulk_refresh_view, name='bulk_refresh')`
2. Add `path('referido/<int:referral_id>/', referral_row_view, name='referral_row')`

Import bulk_refresh_view and referral_row_view in urls.py imports.
Import timedelta from datetime and timezone from django.utils at top of views.py if not present.
  </action>
  <verify>
Run `python ___/manage.py check` - no errors.
Verify URL patterns: `python ___/manage.py show_urls | grep -E "bulk-refresh|referido"` shows both routes.
  </verify>
  <done>
bulk_refresh_view queues tasks for selected referrals with cooldown handling, referral_row_view returns row partial with proper RBAC, URLs are wired.
  </done>
</task>

<task type="auto">
  <name>Task 3a: Update referidos.html template structure</name>
  <files>
    ___/templates/referidos.html
  </files>
  <action>
Update referidos.html template structure (this task handles HTML/template, Task 3b handles JavaScript):

1. **Toast container** (same pattern as profile.html):
   - Add `<div id="toast-container">` with Bootstrap toast markup below navbar

2. **Filter tabs** (nav-pills above table):
   - All | Pendientes | Encontrados | Errores
   - Each button has data-filter attribute matching status groups
   - Active class on "All" by default

3. **Bulk refresh form** (wraps table, only if is_leader):
   ```html
   {% if is_leader %}
   <form id="bulk-refresh-form"
         hx-post="{% url 'bulk_refresh' %}"
         hx-swap="none"
         hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
   {% endif %}
   ```
   - Submit button below table with htmx-indicator spinner
   - Button text: "Actualizar seleccionados"
   - Button initially disabled (enabled via JS when checkboxes selected)
   - Close form tag after table: `{% if is_leader %}</form>{% endif %}`

4. **Table structure**:
   - Sortable headers (Name, Cedula, Fecha, Estado) with data-sort attribute
   - Sort direction icon (bi-arrow-down-up) on each sortable header
   - Checkbox column header (empty th, no select-all per CONTEXT.md)

5. **Table body**:
   - Loop: `{% for referral in referrals %}`
   - Include partial: `{% include 'partials/_referral_row.html' with referral=referral is_leader=is_leader %}`

6. **Empty state** (when no referrals):
   - Wrap in `{% if referrals %}...{% else %}` block
   - Icon: bi-people display-1
   - Message: "No tienes referidos aun"
   - CTA: Input field with referral_url value + Copy button

7. **CSS in style block**:
   - `.detail-row { background-color: #f8f9fa; }`
   - `.referral-row { cursor: pointer; }`
   - `.toggle-icon { transition: transform 0.2s; }`
   - `.referral-row[aria-expanded="true"] .toggle-icon { transform: rotate(90deg); }`
   - HTMX indicator styles (copy from profile.html or _census_section.html)
  </action>
  <verify>
Run `python ___/manage.py check` - no template syntax errors.
Visually inspect template for balanced {% if %}/{% endif %} and {% for %}/{% endfor %} blocks.
  </verify>
  <done>
referidos.html has complete template structure with toast container, filter tabs, bulk refresh form, sortable table, row partials, and empty state.
  </done>
</task>

<task type="auto">
  <name>Task 3b: Add JavaScript interactions to referidos.html</name>
  <files>
    ___/templates/referidos.html
  </files>
  <action>
Add JavaScript section at bottom of referidos.html (in extra_js block or before closing body):

1. **toggleDetail(id)** function:
   - Get detail row by id: `document.getElementById('detail-' + id)`
   - Toggle display: none <-> table-row
   - Toggle aria-expanded on parent row
   - Rotate chevron icon via class toggle

2. **filterTable(status)** function:
   - If status is 'all', show all rows
   - Otherwise filter by data-status attribute groupings:
     - 'pending': PENDING, PROCESSING, NONE
     - 'found': ACTIVE
     - 'errors': ERROR, TIMEOUT, BLOCKED, NOT_FOUND, CANCELLED_DECEASED, CANCELLED_OTHER
   - Hide detail rows when filtering (collapse all expanded)
   - Update active state on filter tabs

3. **sortTable(column)** function:
   - Get all referral rows as array
   - Sort by data-[column] attribute (name, date, status)
   - Toggle sort direction on repeated clicks (store in data-sort-dir)
   - Re-append rows in sorted order
   - Keep detail rows associated with their parent rows

4. **updateBulkButton()** function:
   - Count checked checkboxes
   - Enable/disable bulk refresh button based on count > 0
   - Update button text to show count: "Actualizar seleccionados (N)"

5. **Event listeners**:
   - Checkbox change events call updateBulkButton()
   - Filter tab clicks call filterTable(this.dataset.filter)
   - Column header clicks call sortTable(this.dataset.sort)

6. **HTMX event handlers**:
   - `document.body.addEventListener('showToast', ...)` - handle HX-Trigger toasts (copy pattern from profile.html)
   - `document.body.addEventListener('htmx:afterSwap', ...)` - re-apply current filter after row updates

7. **Copy referral URL** function (for empty state):
   - Get URL from input field
   - Use navigator.clipboard.writeText()
   - Show feedback (change button text briefly)
  </action>
  <verify>
1. Run `python ___/manage.py runserver` and visit /referidos/
2. Click a row - detail should expand/collapse
3. Click filter tabs - rows should filter
4. Click column headers - table should sort
5. If leader with referrals in non-final status: checkboxes visible, bulk refresh button works
6. Browser console shows no JavaScript errors
  </verify>
  <done>
referidos.html has all JavaScript interactions: row expand/collapse, filtering, sorting, bulk refresh button state, and HTMX event handlers.
  </done>
</task>

</tasks>

<verification>
1. `python ___/manage.py check` passes with no errors
2. `/referidos/` page loads and displays census status column
3. Clicking a row expands to show location details (or error hint)
4. Filter tabs correctly filter the table by status
5. Column headers sort the table
6. Leader can select multiple checkboxes and click bulk refresh
7. Toast notification appears after bulk refresh
8. Checkboxes only appear for non-final statuses (not ACTIVE/CANCELLED)
9. Per-referral refresh button uses existing /refrescar-cedula/<user_id>/ endpoint
10. Bulk refresh skips users refreshed within last 30 seconds
11. Empty state shows copy-able referral link
12. Non-leader users see table but no checkboxes or bulk refresh button
</verification>

<success_criteria>
- DISP-03: Referidos table displays status badge for each referral with expandable location details
- DISP-04: Bulk refresh button visible only for leaders, operates on selected checkboxes
- DISP-05: Individual row updates via HTMX after refresh, filter tabs provide status views
- RBAC-06: Bulk refresh restricted to leaders via view-level check
- Checkboxes only visible for refreshable (non-final) statuses
- Cooldown logic prevents refresh spam (30-second window)
- All existing referidos functionality preserved (table display, navigation)
</success_criteria>

<output>
After completion, create `.planning/phases/16-referidos-page-updates/16-01-SUMMARY.md`
</output>
