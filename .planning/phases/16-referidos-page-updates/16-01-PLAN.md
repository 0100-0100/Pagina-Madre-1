---
phase: 16-referidos-page-updates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ___/accounts/views.py
  - ___/accounts/urls.py
  - ___/templates/referidos.html
  - ___/templates/partials/_referral_row.html
autonomous: true

must_haves:
  truths:
    - "Leader sees census status badge for each referred user in table"
    - "Leader can expand row to see full voting location details"
    - "Leader can select multiple referrals and trigger bulk refresh"
    - "Bulk refresh only available for non-final statuses (not ACTIVE/CANCELLED)"
    - "Filter tabs allow viewing by status category (All/Pendientes/Encontrados/Errores)"
    - "Table columns are sortable by clicking headers"
    - "Empty state shows referral link copy button"
  artifacts:
    - path: "___/templates/referidos.html"
      provides: "Referidos page with census columns, filters, expandable rows, bulk refresh"
      contains: "hx-post"
    - path: "___/templates/partials/_referral_row.html"
      provides: "Single referral row partial for HTMX updates"
      contains: "data-status"
    - path: "___/accounts/views.py"
      provides: "bulk_refresh_view and updated referidos_view"
      exports: ["bulk_refresh_view", "referidos_view"]
    - path: "___/accounts/urls.py"
      provides: "URL routes for bulk refresh and row polling"
      contains: "bulk-refresh"
  key_links:
    - from: "___/templates/referidos.html"
      to: "bulk_refresh_view"
      via: "HTMX form POST"
      pattern: "hx-post.*bulk-refresh"
    - from: "bulk_refresh_view"
      to: "async_task"
      via: "Django-Q2 task queue"
      pattern: "async_task.*validate_cedula"
---

<objective>
Update referidos page to display census status for each referred user with expandable location details, filter tabs, sortable columns, and bulk refresh capability for leaders.

Purpose: Leaders need visibility into census validation status for all their referrals and ability to trigger bulk re-validation for failed/pending lookups.
Output: Enhanced referidos.html with census column, expandable rows, filter tabs, and bulk refresh form.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase-specific context
@.planning/phases/16-referidos-page-updates/16-CONTEXT.md
@.planning/phases/16-referidos-page-updates/16-RESEARCH.md

# Prior phase patterns (HTMX, RBAC, census display)
@.planning/phases/15-profile-display-refresh/15-01-SUMMARY.md
@.planning/phases/15-profile-display-refresh/15-02-SUMMARY.md

# Existing implementation files
@___/accounts/views.py
@___/accounts/decorators.py
@___/accounts/models.py
@___/templates/referidos.html
@___/templates/partials/_census_section.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update referidos_view and create row partial</name>
  <files>
    ___/accounts/views.py
    ___/templates/partials/_referral_row.html
  </files>
  <action>
Update `referidos_view` in views.py:
1. Add `select_related('cedula_info')` to the referrals query for efficient loading
2. Add `is_leader` context variable (request.user.role == CustomUser.Role.LEADER)
3. Add `referral_url` context for empty state copy button

Create `___/templates/partials/_referral_row.html` partial:
1. Main row (`<tr class="referral-row">`) with data attributes:
   - `data-id="{{ referral.id }}"`
   - `data-status="{{ referral.cedula_info.status|default:'NONE' }}"`
   - `data-name="{{ referral.nombre_completo }}"` (for client-side sorting)
   - `data-date="{{ referral.date_joined|date:'Y-m-d' }}"` (for sorting)
2. Columns: Checkbox (if leader + can_refresh), Name, Cedula, Registration Date, Status Badge
3. Checkbox column: Only show if is_leader AND status NOT in ['ACTIVE', 'CANCELLED_DECEASED', 'CANCELLED_OTHER']
4. Status badge using Bootstrap colors per CONTEXT.md:
   - `bg-success` for ACTIVE (Encontrado)
   - `bg-warning text-dark` with spinner for PENDING/PROCESSING (Pendiente)
   - `bg-secondary` for NOT_FOUND (No encontrado)
   - `bg-secondary` for CANCELLED_* (Cancelada)
   - `bg-danger` for ERROR/TIMEOUT/BLOCKED (Error)
5. Row is clickable to expand (onclick="toggleDetail({{ referral.id }})")
6. Chevron icon that rotates on expand

Detail row (`<tr class="detail-row" id="detail-{{ referral.id }}" style="display: none;">`):
1. colspan="5" (checkbox + 4 columns)
2. Show location fields if cedula_info.status == 'ACTIVE': departamento, municipio, puesto, direccion, mesa
3. Show error hint if ERROR/TIMEOUT/BLOCKED: "Error al consultar - intenta de nuevo mas tarde"
4. Show timestamp in user's local time using JavaScript Date API with data-utc attribute
5. Per-referral refresh button (only if leader AND status allows refresh):
   - hx-post to refresh_cedula_user endpoint
   - hx-target="#row-{{ referral.id }}" to replace entire row pair
   - hx-indicator for spinner

Use `{% load humanize %}` for naturaltime filter on fetched_at.
  </action>
  <verify>
Run `python ___/manage.py check` - no errors.
Manually verify partial template syntax by inspecting the file for unclosed tags.
  </verify>
  <done>
referidos_view returns cedula_info data, _referral_row.html partial renders status badges and expandable detail rows.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create bulk refresh view and wire URL routes</name>
  <files>
    ___/accounts/views.py
    ___/accounts/urls.py
  </files>
  <action>
Add `bulk_refresh_view` to views.py:
1. Decorator: `@login_required` then check `request.user.role == CustomUser.Role.LEADER` (return 403 if not)
2. Accept POST with `request.POST.getlist('ids')` for selected referral IDs
3. Limit to max 10 per request (ids = ids[:10])
4. Query referrals: `CustomUser.objects.filter(id__in=ids, referred_by=request.user).select_related('cedula_info')`
5. For each referral:
   - Skip if cedula_info.status in ['ACTIVE', 'CANCELLED_DECEASED', 'CANCELLED_OTHER', 'PROCESSING']
   - Set status to PROCESSING and save
   - Queue async_task('accounts.tasks.validate_cedula', referral.id, 1)
   - Increment refreshed counter
6. Return partial response with HX-Trigger for toast: `{"showToast": {"message": "N cedulas en actualizacion", "type": "info"}}`
7. Return empty response if no IDs selected (with warning toast)

Add `referral_row_view` to views.py (for HTMX row polling):
1. Decorator: `@login_required` then verify request.user is LEADER and referral.referred_by == request.user
2. Accept `referral_id` parameter
3. Return `_referral_row.html` partial for that single referral

Update urls.py:
1. Add `path('bulk-refresh/', bulk_refresh_view, name='bulk_refresh')`
2. Add `path('referido/<int:referral_id>/', referral_row_view, name='referral_row')`

Import bulk_refresh_view and referral_row_view in urls.py imports.
  </action>
  <verify>
Run `python ___/manage.py check` - no errors.
Verify URL patterns: `python ___/manage.py show_urls | grep -E "bulk-refresh|referido"` shows both routes.
  </verify>
  <done>
bulk_refresh_view queues tasks for selected referrals, referral_row_view returns row partial, URLs are wired.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update referidos.html with full UI</name>
  <files>
    ___/templates/referidos.html
  </files>
  <action>
Rewrite referidos.html to include all Phase 16 features:

1. **Toast container and handler** (same pattern as profile.html):
   - Add `<div id="toast-container">` below navbar
   - Add showToast event listener (copy from profile.html)

2. **Filter tabs** (nav-pills above table):
   - All | Pendientes | Encontrados | Errores
   - data-filter attribute on each button
   - Active state management via JavaScript
   - Filter logic: show/hide rows based on data-status attribute

3. **Bulk refresh form** (wraps table, only if is_leader):
   ```html
   <form id="bulk-refresh-form"
         hx-post="{% url 'bulk_refresh' %}"
         hx-swap="none"
         hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
   ```
   - Submit button below table with htmx-indicator spinner
   - Button disabled when no checkboxes selected (via JavaScript)

4. **Table structure**:
   - Sortable headers (Name, Cedula, Fecha, Estado) with onclick="sortTable('column')"
   - Sort direction icon (bi-arrow-down-up)
   - Checkbox column header (empty, no select-all per CONTEXT.md)

5. **Table body**:
   - Loop: `{% for referral in referrals %}`
   - Include partial: `{% include 'partials/_referral_row.html' with referral=referral is_leader=is_leader %}`

6. **Empty state** (when no referrals):
   - Icon: bi-people display-1
   - Message: "No tienes referidos aun"
   - CTA: Input with referral_url + Copy button using navigator.clipboard

7. **JavaScript section** at bottom:
   - `toggleDetail(id)`: Show/hide detail row, toggle aria-expanded, rotate chevron icon
   - `filterTable(status)`: Filter rows by data-status, update active tab, hide expanded details
   - `sortTable(column)`: Sort rows by data attribute, maintain detail row association
   - `updateBulkButton()`: Enable/disable bulk refresh based on checkbox count
   - Checkbox change event listener calling updateBulkButton()

8. **HTMX event handlers**:
   - `htmx:afterSwap` on table body to re-run filterTable if filter active
   - showToast event handler for HX-Trigger toasts

CSS additions (in style block):
- `.detail-row { background-color: #f8f9fa; }` (slightly different background)
- `.referral-row { cursor: pointer; }`
- `.toggle-icon { transition: transform 0.2s; }`
- `.referral-row[aria-expanded="true"] .toggle-icon { transform: rotate(90deg); }`
- HTMX indicator styles (same as _census_section.html)
  </action>
  <verify>
1. Run `python ___/manage.py runserver` and visit /referidos/
2. Verify table displays with Status column
3. Click a row - detail should expand/collapse
4. Click filter tabs - rows should filter
5. Click column headers - table should sort
6. If leader with referrals in non-final status: checkboxes visible, bulk refresh button works
7. Browser console shows no JavaScript errors
  </verify>
  <done>
Referidos page shows census status, expandable details, filter tabs, sortable columns, bulk refresh for leaders.
  </done>
</task>

</tasks>

<verification>
1. `python ___/manage.py check` passes with no errors
2. `/referidos/` page loads and displays census status column
3. Clicking a row expands to show location details (or error hint)
4. Filter tabs correctly filter the table by status
5. Column headers sort the table
6. Leader can select multiple checkboxes and click bulk refresh
7. Toast notification appears after bulk refresh
8. Empty state shows copy-able referral link
9. Non-leader users see table but no checkboxes or bulk refresh button
</verification>

<success_criteria>
- DISP-03: Referidos table displays status badge for each referral with expandable location details
- DISP-04: Bulk refresh button visible only for leaders, operates on selected checkboxes
- DISP-05: Individual row updates via HTMX after refresh, filter tabs provide status views
- RBAC-06: Bulk refresh restricted to leaders via view-level check
- All existing referidos functionality preserved (table display, navigation)
</success_criteria>

<output>
After completion, create `.planning/phases/16-referidos-page-updates/16-01-SUMMARY.md`
</output>
