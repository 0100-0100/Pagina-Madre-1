---
phase: 07-referral-model-registration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ___/accounts/models.py
  - ___/accounts/admin.py
  - ___/accounts/migrations/0002_add_referral_fields.py
  - ___/accounts/migrations/0003_populate_referral_codes.py
  - ___/accounts/migrations/0004_referral_unique_constraint.py
autonomous: true

must_haves:
  truths:
    - "Every user has a unique 8-character alphanumeric referral_code"
    - "Users can optionally have a referred_by relationship to another user"
    - "Users have a referral_goal with default value of 10"
    - "All existing users have referral codes populated"
    - "Deleting a referrer preserves the referred user (SET_NULL)"
  artifacts:
    - path: "___/accounts/models.py"
      provides: "CustomUser with referral_code, referred_by, referral_goal fields"
      contains: "referral_code"
    - path: "___/accounts/admin.py"
      provides: "Admin display of referral fields"
      contains: "referral_code"
    - path: "___/accounts/migrations/0002_add_referral_fields.py"
      provides: "Migration adding nullable referral fields"
    - path: "___/accounts/migrations/0003_populate_referral_codes.py"
      provides: "Data migration populating codes for existing users"
      contains: "RunPython"
    - path: "___/accounts/migrations/0004_referral_unique_constraint.py"
      provides: "Migration adding unique constraint to referral_code"
  key_links:
    - from: "___/accounts/models.py"
      to: "database"
      via: "Django ORM migrations"
      pattern: "referral_code.*unique=True"
---

<objective>
Add referral tracking fields to CustomUser model with proper migrations for existing data.

Purpose: Foundation for referral system - users need codes to share and referred_by tracking.
Output: CustomUser model with three new fields, migrations applied, admin updated.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-referral-model-registration/07-RESEARCH.md

# Current model to extend
@___/accounts/models.py
@___/accounts/admin.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add referral fields to CustomUser model</name>
  <files>___/accounts/models.py</files>
  <action>
Add three new fields to the CustomUser model:

1. Add import at top of file:
   ```python
   from django.utils.crypto import get_random_string
   ```

2. Add helper function before the class:
   ```python
   def generate_referral_code():
       """Generate unique 8-char alphanumeric referral code."""
       return get_random_string(length=8)
   ```

3. Add these fields to CustomUser class (after data_policy_accepted):
   ```python
   referral_code = models.CharField(
       max_length=8,
       unique=True,
       editable=False,
       default=generate_referral_code,
       verbose_name='Codigo de referido'
   )

   referred_by = models.ForeignKey(
       'self',
       on_delete=models.SET_NULL,
       null=True,
       blank=True,
       related_name='referrals',
       verbose_name='Referido por'
   )

   referral_goal = models.PositiveIntegerField(
       default=10,
       verbose_name='Meta de referidos'
   )
   ```

IMPORTANT: Use `default=generate_referral_code` (callable reference, NO parentheses).
Do NOT use `default=get_random_string(8)` - this would generate same code for all users.
  </action>
  <verify>
Run `python ___/manage.py check` - should pass with no errors.
  </verify>
  <done>
models.py contains referral_code, referred_by, and referral_goal fields with correct configuration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create and apply three-step migrations</name>
  <files>
___/accounts/migrations/0002_add_referral_fields.py
___/accounts/migrations/0003_populate_referral_codes.py
___/accounts/migrations/0004_referral_unique_constraint.py
  </files>
  <action>
The three-step migration is needed because adding a unique field to existing data requires:
1. Add nullable field
2. Populate values
3. Add unique constraint

**Step 1: Generate initial migration (Django auto-detects new fields)**
Run: `python ___/manage.py makemigrations accounts --name add_referral_fields`

This creates 0002_add_referral_fields.py automatically.

**Step 2: Create data migration for existing users**
Run: `python ___/manage.py makemigrations accounts --empty --name populate_referral_codes`

Then edit 0003_populate_referral_codes.py to contain:
```python
from django.db import migrations


def generate_referral_codes(apps, schema_editor):
    """Generate unique referral codes for all existing users."""
    from django.utils.crypto import get_random_string

    CustomUser = apps.get_model('accounts', 'CustomUser')
    existing_codes = set(
        CustomUser.objects.exclude(referral_code__isnull=True)
        .values_list('referral_code', flat=True)
    )

    for user in CustomUser.objects.filter(referral_code__isnull=True):
        while True:
            code = get_random_string(8)
            if code not in existing_codes:
                existing_codes.add(code)
                user.referral_code = code
                user.save(update_fields=['referral_code'])
                break


def reverse_codes(apps, schema_editor):
    """Reverse migration - set all codes to None."""
    CustomUser = apps.get_model('accounts', 'CustomUser')
    CustomUser.objects.all().update(referral_code=None)


class Migration(migrations.Migration):
    dependencies = [
        ('accounts', '0002_add_referral_fields'),
    ]

    operations = [
        migrations.RunPython(generate_referral_codes, reverse_codes),
    ]
```

**Step 3: Apply migrations**
Run: `python ___/manage.py migrate accounts`

All three migrations should apply successfully.
  </action>
  <verify>
1. Run `python ___/manage.py showmigrations accounts` - all migrations should show [X]
2. Run `python ___/manage.py shell -c "from accounts.models import CustomUser; print(CustomUser.objects.first().referral_code if CustomUser.objects.exists() else 'No users')"` - should print a code or 'No users'
  </verify>
  <done>
All migrations applied. Existing users have referral codes. New users get auto-generated codes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update admin to display referral fields</name>
  <files>___/accounts/admin.py</files>
  <action>
Update CustomUserAdmin to display and organize the new referral fields:

```python
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from .models import CustomUser


class CustomUserAdmin(UserAdmin):
    # Display custom fields in admin list view
    list_display = UserAdmin.list_display + (
        'cedula', 'phone', 'referral_code', 'referred_by', 'referral_goal'
    )

    # Make referral_code read-only (auto-generated)
    readonly_fields = ('referral_code',)

    # Add custom fields to admin detail view
    fieldsets = UserAdmin.fieldsets + (
        ('Additional Info', {
            'fields': ('cedula', 'nombre_completo', 'phone', 'data_policy_accepted')
        }),
        ('Referral Info', {
            'fields': ('referral_code', 'referred_by', 'referral_goal')
        }),
    )

    # Include custom fields when adding new user via admin
    add_fieldsets = UserAdmin.add_fieldsets + (
        ('Additional Info', {
            'fields': ('cedula', 'nombre_completo', 'phone', 'data_policy_accepted')
        }),
    )


admin.site.register(CustomUser, CustomUserAdmin)
```

Note: referral_code is in readonly_fields so it cannot be edited.
Note: referral_code is NOT in add_fieldsets - it's auto-generated on save.
  </action>
  <verify>
1. Run `python ___/manage.py runserver` (start server)
2. Visit http://127.0.0.1:8000/admin/ and log in
3. Click on "Custom users" - should see referral_code, referred_by, referral_goal columns
4. Click on any user - should see "Referral Info" section with read-only referral_code
  </verify>
  <done>
Admin shows all referral fields. referral_code visible but not editable. referred_by is selectable dropdown.
  </done>
</task>

</tasks>

<verification>
All tasks verified when:
1. `python ___/manage.py check` passes
2. All migrations applied (showmigrations shows [X])
3. Admin displays referral fields correctly
4. Existing users have unique 8-char codes
5. Creating new user via admin generates unique code automatically
</verification>

<success_criteria>
- REF-01: CustomUser.referral_code exists, unique=True, 8 chars, auto-generated
- REF-02: CustomUser.referred_by is ForeignKey to self with SET_NULL
- REF-03: CustomUser.referral_goal is PositiveIntegerField with default=10
- REF-04: All existing users have populated referral codes
- Admin displays all new fields with referral_code read-only
</success_criteria>

<output>
After completion, create `.planning/phases/07-referral-model-registration/07-01-SUMMARY.md`
</output>
