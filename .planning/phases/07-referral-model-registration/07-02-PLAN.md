---
phase: 07-referral-model-registration
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - ___/accounts/views.py
autonomous: true

must_haves:
  truths:
    - "Registration URL accepts ?ref=CODE query parameter"
    - "Valid referral code sets referred_by on new user"
    - "Invalid referral code proceeds with registration (no error)"
    - "Missing referral code proceeds with registration (no error)"
  artifacts:
    - path: "___/accounts/views.py"
      provides: "Registration view with referral code capture"
      contains: "ref_code"
  key_links:
    - from: "___/accounts/views.py"
      to: "___/accounts/models.py"
      via: "CustomUser.objects.filter(referral_code=ref_code)"
      pattern: "referral_code"
---

<objective>
Modify registration view to capture referral codes from URL and link new users to their referrer.

Purpose: Enable the referral flow - users clicking shared links get correctly tracked.
Output: Registration view that captures ?ref=CODE and sets referred_by relationship.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-referral-model-registration/07-RESEARCH.md
@.planning/phases/07-referral-model-registration/07-01-SUMMARY.md

# Current view to modify
@___/accounts/views.py
@___/accounts/forms.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify register view to capture referral code</name>
  <files>___/accounts/views.py</files>
  <action>
Update the register() function to:
1. Capture the `ref` query parameter from the URL
2. Look up the referrer (gracefully handle invalid/missing codes)
3. Set referred_by on the new user before saving

Replace the existing register function with:

```python
def register(request):
    """User registration view with referral code capture."""
    # REG-01: Capture ref parameter from URL
    ref_code = request.GET.get('ref')
    referrer = None

    # REG-02/REG-03: Look up referrer, gracefully handle invalid/missing
    if ref_code:
        from .models import CustomUser
        referrer = CustomUser.objects.filter(referral_code=ref_code).first()

    if request.method == 'POST':
        form = CustomUserCreationForm(request.POST)
        if form.is_valid():
            user = form.save(commit=False)
            user.referred_by = referrer  # May be None if invalid/missing code
            user.save()
            login(request, user)
            try:
                return redirect('home')
            except:
                return redirect('/admin/')
    else:
        form = CustomUserCreationForm()

    return render(request, 'registration/register.html', {'form': form})
```

Key points:
- Use `.filter().first()` instead of `.get()` to avoid DoesNotExist exceptions
- referrer is None if code is invalid or missing (satisfies REG-03)
- Import CustomUser inside function to avoid circular imports
- user.referred_by = referrer works whether referrer is None or a user instance
  </action>
  <verify>
Run `python ___/manage.py check` - should pass with no errors.
  </verify>
  <done>
register() view captures ref parameter and sets referred_by appropriately.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify complete registration flow</name>
  <files>None (verification only)</files>
  <action>
Test the complete registration flow with all scenarios:

**Test 1: Registration with valid referral code**
1. Start server: `python ___/manage.py runserver`
2. Get a valid referral code from admin (note down a user's code)
3. Visit: `http://127.0.0.1:8000/register/?ref=VALIDCODE` (use actual code)
4. Complete registration with new unique cedula
5. Check in admin that new user has referred_by set to the code owner

**Test 2: Registration with invalid referral code**
1. Visit: `http://127.0.0.1:8000/register/?ref=INVALID123`
2. Complete registration with new unique cedula
3. Verify registration succeeds (no error)
4. Check in admin that new user has referred_by = None

**Test 3: Registration without referral code**
1. Visit: `http://127.0.0.1:8000/register/`
2. Complete registration with new unique cedula
3. Verify registration succeeds
4. Check in admin that new user has referred_by = None

**Test 4: SET_NULL behavior (if referrer exists)**
1. In admin, delete a user who has referred someone
2. Verify the referred user still exists with referred_by = None

All tests should pass for phase to be complete.
  </action>
  <verify>
1. Valid code: New user's referred_by points to correct referrer
2. Invalid code: Registration succeeds, referred_by is None
3. No code: Registration succeeds, referred_by is None
4. SET_NULL: Referred users survive referrer deletion
  </verify>
  <done>
All four registration scenarios work correctly. Referral tracking is operational.
  </done>
</task>

</tasks>

<verification>
Phase 7 complete when:
1. `/register/?ref=VALIDCODE` creates user with correct referred_by
2. `/register/?ref=INVALIDCODE` creates user normally (no error)
3. `/register/` (no param) creates user normally
4. Deleting referrer preserves referred users (SET_NULL behavior)
5. All users (new and existing) have unique 8-char referral codes
</verification>

<success_criteria>
- REG-01: Registration URL accepts `?ref=CODE` parameter
- REG-02: Valid referral code sets referred_by on new user
- REG-03: Invalid or missing referral code proceeds without error
- Phase 7 success criteria 1-4 all met
</success_criteria>

<output>
After completion, create `.planning/phases/07-referral-model-registration/07-02-SUMMARY.md`
</output>
