---
phase: bug-hunting-v1.3
task: Bug hunting - 8 bugs fixed, testing remaining features
total_tasks: Unknown (exploratory)
status: in_progress
last_updated: 2026-01-23T00:15:00
---

<current_state>
We are in the **v1.3 Bug Hunting Phase** - testing all milestone features before archiving.

**8 bugs have been discovered and fixed.** All verified working.

Session paused after fixing Bug #8 (multiprocessing fork placement).
User was about to report Bug #9 or continue testing remaining features.
</current_state>

<bug_hunting_workflow>

## Starting Bug Hunting Session

**ALWAYS start both background servers before testing:**

```bash
# Terminal 1 - Django development server
cd /Users/Diego.Lopezruiz/Documents/Repositories/Pagina-Madre-1/___ && \
source ../.venv/bin/activate && \
python manage.py runserver 0.0.0.0:8000

# Terminal 2 - Django-Q2 task worker
cd /Users/Diego.Lopezruiz/Documents/Repositories/Pagina-Madre-1/___ && \
source ../.venv/bin/activate && \
python manage.py qcluster
```

**In Claude Code, use background tasks:**
```
Bash tool with run_in_background=true for both commands
```

**Why both servers are required:**
- `runserver`: Serves the web application (port 8000)
- `qcluster`: Processes background tasks (cedula validation, Playwright scraping)

Without qcluster running, background tasks will be queued but never processed.

</bug_hunting_workflow>

<completed_work>

## Bugs Found & Fixed (8 total)

| Bug | Issue | Status |
|-----|-------|--------|
| #1 | TemplateSyntaxError on /referidos/ | RESOLVED |
| #2 | Django admin AttributeError (Python 3.14) | RESOLVED |
| #3 | Django-Q tasks fail "Function not defined" | RESOLVED |
| #4 | Task not queued from remote client (iPhone) | RESOLVED |
| #5 | UI perpetual loading when task fails | RESOLVED |
| #6 | Referidos page no auto-update | RESOLVED |
| #7 | OOB swap + retry button + template wrapper | RESOLVED |
| #8 | Registration tasks fail (multiprocessing placement) | RESOLVED |

## Key Fixes Applied

1. **Error handling in signals.py**: Added try/except and logging to `_queue_validation_task`
2. **Stale status detection in models.py**: `is_stale()` and `reset_if_stale()` methods
3. **Retry button for users**: Added to `_census_section.html` for ERROR status
4. **Referidos batch polling**: New `pending_referrals_view` + `_pending_referrals.html`
5. **OOB swap fix**: Changed to `hx-swap-oob="outerHTML"` for proper `<tr>` replacement
6. **Template wrapper for OOB**: Wrapped `<tr>` in `<template>` tags to prevent browser HTML mangling
7. **Multiprocessing fork placement**: Moved to very top of settings.py before any imports
</completed_work>

<remaining_work>

1. **Continue bug hunting**: Test remaining v1.3 features
   - [ ] Django-Q2 task queue (verify tasks process reliably)
   - [ ] Playwright census scraping (verify browser opens in DEBUG mode)
   - [ ] RBAC controls (leader vs regular user permissions)
   - [ ] 30-second cooldown (verify rate limiting works)
   - [ ] Bulk refresh (select multiple referrals, refresh all)

2. **Run `/gsd:audit-milestone`**: Verify all requirements satisfied

3. **Run `/gsd:complete-milestone`**: Archive v1.3
</remaining_work>

<decisions_made>

- Stale timeout: 2 min for PENDING, 5 min for PROCESSING
- Regular users can retry their own failed verifications (not just leaders)
- Batch polling with IDs: Client sends row IDs to track, server returns regardless of status
- OOB swap mode: `outerHTML` required for `<tr>` elements (not `true`/innerHTML)
- Template wrapper: `<template>` tags required for OOB `<tr>` elements to prevent browser mangling
- Multiprocessing fork: Must be set at very top of settings.py before any imports
</decisions_made>

<blockers>

(None currently - Bug #8 resolved the intermittent worker issue)
</blockers>

<context>
This is the final validation phase before archiving v1.3. All code changes are complete.
The milestone implements:
- Django-Q2 background task queue (SQLite-compatible)
- Playwright census scraping from Registradur√≠a
- CedulaInfo model with status tracking
- HTMX polling for real-time UI updates
- Leader bulk refresh capability
- User retry button for failed verifications

All 8 bugs discovered during bug hunting have been fixed and verified.
Ready to continue testing or move to audit if user is satisfied.
</context>

<files_modified>
**Not yet committed (this session's changes):**
- ___/___/settings.py (multiprocessing fork moved to top)
- ___/templates/partials/_pending_referrals.html (template wrapper for OOB)

**Previously modified (from earlier bug hunting):**
- ___/accounts/models.py (stale detection methods)
- ___/accounts/signals.py (error handling + logging)
- ___/accounts/urls.py (pending_referrals route)
- ___/accounts/views.py (pending_referrals_view, stale checks)
- ___/templates/partials/_census_section.html (retry button)
- ___/templates/referidos.html (polling trigger with IDs)

**Planning docs:**
- .planning/BUGTRACKER.md (8 bugs documented)
- .planning/PROJECT.md (workflow convention added)
</files_modified>

<next_action>
**To resume:**

1. Start both servers (see bug_hunting_workflow section above)
2. Either:
   - Report Bug #9 if user found another issue
   - Continue testing remaining features (RBAC, cooldown, bulk refresh)
   - Run `/gsd:audit-milestone` if satisfied with testing

**When done with all testing:**
1. `/gsd:audit-milestone` - verify requirements
2. `/gsd:complete-milestone` - archive v1.3
</next_action>
