---
phase: bug-hunting-v1.3
task: Testing Bug #7 OOB swap fix
total_tasks: Unknown (bug hunting)
status: in_progress
last_updated: 2026-01-21T19:15:00
---

<current_state>
We are in the **v1.3 Bug Hunting Phase** - testing all milestone features before archiving.

Just applied a fix for Bug #7 (OOB swap mode) and waiting for user to test.
The fix changed `hx-swap-oob="true"` to `hx-swap-oob="outerHTML"` so table rows properly replace.
</current_state>

<completed_work>

## Bugs Found & Fixed (7 total)

| Bug | Issue | Status |
|-----|-------|--------|
| #1 | TemplateSyntaxError on /referidos/ | RESOLVED |
| #2 | Django admin AttributeError (Python 3.14) | RESOLVED |
| #3 | Django-Q tasks fail "Function not defined" | RESOLVED |
| #4 | Task not queued from remote client (iPhone) | RESOLVED |
| #5 | UI perpetual loading when task fails | RESOLVED |
| #6 | Referidos page no auto-update | RESOLVED |
| #7 | Missing retry button + OOB swap fix | RESOLVED (testing) |

## Key Fixes Applied This Session

1. **Error handling in signals.py**: Added try/except and logging to `_queue_validation_task`
2. **Stale status detection in models.py**: `is_stale()` and `reset_if_stale()` methods
3. **Retry button for users**: Added to `_census_section.html` for ERROR status
4. **Referidos batch polling**: New `pending_referrals_view` + `_pending_referrals.html`
5. **OOB swap fix**: Changed to `hx-swap-oob="outerHTML"` for proper `<tr>` replacement
</completed_work>

<remaining_work>

1. **Test Bug #7 fix**: Verify referidos page now updates when row status changes
2. **Investigate intermittent worker issue**: Tasks sometimes not picked up by qcluster
3. **Continue bug hunting**: Test remaining v1.3 features
4. **Run `/gsd:audit-milestone`**: Verify all requirements satisfied
5. **Run `/gsd:complete-milestone`**: Archive v1.3
</remaining_work>

<decisions_made>

- Stale timeout: 2 min for PENDING, 5 min for PROCESSING
- Regular users can retry their own failed verifications (not just leaders)
- Batch polling with IDs: Client sends row IDs to track, server returns regardless of status
- OOB swap mode: `outerHTML` required for `<tr>` elements (not `true`/innerHTML)
</decisions_made>

<blockers>

- **Intermittent worker issue**: Tasks sometimes queued but not processed by qcluster
  - Seems related to SQLite locking during concurrent access
  - Logs show task queued but worker never picks it up
  - Not blocking - stale detection provides fallback
</blockers>

<context>
We added a workflow convention to PROJECT.md:
> Before `/gsd:complete-milestone`, always do manual bug hunting

This session focused on testing v1.3 features (cedula validation, HTMX polling,
referidos page updates) and fixing bugs discovered during testing.

The main challenge was getting the referidos page to auto-update when referral
statuses change. Required:
1. Tracking which rows need updates (by ID, not by status)
2. Using correct OOB swap mode for table rows
3. Handling status transitions that happen outside the polling (e.g., stale check)
</context>

<files_modified>
**Not yet committed:**
- .planning/BUGTRACKER.md (7 bugs documented)
- .planning/PROJECT.md (workflow convention added)
- .planning/STATE.md (bug hunting status)
- ___/accounts/models.py (stale detection)
- ___/accounts/signals.py (error handling)
- ___/accounts/urls.py (pending_referrals route)
- ___/accounts/views.py (pending_referrals_view, stale checks)
- ___/templates/partials/_census_section.html (retry button)
- ___/templates/referidos.html (polling trigger)
- ___/templates/partials/_pending_referrals.html (NEW - OOB response)
</files_modified>

<next_action>
User will test the Bug #7 OOB swap fix by:
1. Registering a new referral
2. Watching the referidos page
3. Verifying status updates from "Pendiente" to final status

If polling works: Continue bug hunting or proceed to audit
If polling fails: Debug the HTMX response/swap behavior
</next_action>
