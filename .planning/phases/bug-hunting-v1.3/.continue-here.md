---
phase: bug-hunting-v1.3
task: Testing Bug #7 OOB swap fix
total_tasks: Unknown (bug hunting)
status: in_progress
last_updated: 2026-01-22T10:00:00
---

<current_state>
We are in the **v1.3 Bug Hunting Phase** - testing all milestone features before archiving.

Bug #7 fix has been applied but NOT yet tested by user. The fix changed `hx-swap-oob="true"` to `hx-swap-oob="outerHTML"` on `<tr>` elements in `_pending_referrals.html` so table rows properly replace via HTMX out-of-band swaps.

User was about to test but paused. **Testing has NOT been performed.**
</current_state>

<completed_work>

## Bugs Found & Fixed (7 total)

| Bug | Issue | Status |
|-----|-------|--------|
| #1 | TemplateSyntaxError on /referidos/ | RESOLVED |
| #2 | Django admin AttributeError (Python 3.14) | RESOLVED |
| #3 | Django-Q tasks fail "Function not defined" | RESOLVED |
| #4 | Task not queued from remote client (iPhone) | RESOLVED |
| #5 | UI perpetual loading when task fails | RESOLVED |
| #6 | Referidos page no auto-update | RESOLVED |
| #7 | Missing retry button + OOB swap fix | RESOLVED (NEEDS TESTING) |

## Key Fixes Applied

1. **Error handling in signals.py**: Added try/except and logging to `_queue_validation_task`
2. **Stale status detection in models.py**: `is_stale()` and `reset_if_stale()` methods
3. **Retry button for users**: Added to `_census_section.html` for ERROR status
4. **Referidos batch polling**: New `pending_referrals_view` + `_pending_referrals.html`
5. **OOB swap fix**: Changed to `hx-swap-oob="outerHTML"` for proper `<tr>` replacement
</completed_work>

<remaining_work>

1. **Test Bug #7 fix**: Verify referidos page now updates when row status changes
   - Register a new referral using referral link
   - Watch the referidos page for automatic updates
   - Verify status changes from "Pendiente" to final status without page refresh

2. **Continue bug hunting if needed**: Test remaining v1.3 features
   - Django-Q2 task queue
   - Playwright census scraping
   - RBAC controls
   - 30-second cooldown

3. **Run `/gsd:audit-milestone`**: Verify all requirements satisfied

4. **Run `/gsd:complete-milestone`**: Archive v1.3
</remaining_work>

<decisions_made>

- Stale timeout: 2 min for PENDING, 5 min for PROCESSING
- Regular users can retry their own failed verifications (not just leaders)
- Batch polling with IDs: Client sends row IDs to track, server returns regardless of status
- OOB swap mode: `outerHTML` required for `<tr>` elements (not `true`/innerHTML)
</decisions_made>

<blockers>

- **Intermittent worker issue**: Tasks sometimes queued but not processed by qcluster
  - Seems related to SQLite locking during concurrent access
  - Logs show task queued but worker never picks it up
  - Not blocking - stale detection provides fallback
</blockers>

<context>
This is the final validation phase before archiving v1.3. All code changes are complete.
The milestone implements:
- Django-Q2 background task queue (SQLite-compatible)
- Playwright census scraping from Registraduría
- CedulaInfo model with status tracking
- HTMX polling for real-time UI updates
- Leader bulk refresh capability
- User retry button for failed verifications

All 7 bugs discovered during bug hunting have been fixed. Bug #7 (OOB swap) is the final fix
that needs manual verification before we can proceed to audit.
</context>

<files_modified>
**Not yet committed:**
- ___/accounts/models.py (stale detection methods)
- ___/accounts/signals.py (error handling + logging)
- ___/accounts/urls.py (pending_referrals route)
- ___/accounts/views.py (pending_referrals_view, stale checks)
- ___/templates/partials/_census_section.html (retry button)
- ___/templates/referidos.html (polling trigger with IDs)
- ___/templates/partials/_pending_referrals.html (NEW - OOB swap response)

**Planning docs:**
- .planning/BUGTRACKER.md (7 bugs documented)
- .planning/PROJECT.md (workflow convention added)
- .planning/STATE.md (bug hunting status)
</files_modified>

<next_action>
**Test Bug #7 OOB swap fix:**

1. Start servers:
   ```bash
   # Terminal 1
   python manage.py runserver

   # Terminal 2
   python manage.py qcluster
   ```

2. Login as user with referrals, go to /referidos/

3. Register a new user using the referral link (incognito window)

4. Watch referidos page - row should auto-update from "Pendiente" to final status

5. If works → `/gsd:audit-milestone`
   If fails → debug HTMX response in browser DevTools
</next_action>
