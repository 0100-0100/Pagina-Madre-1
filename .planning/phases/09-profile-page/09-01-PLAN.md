---
phase: 09-profile-page
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ___/accounts/forms.py
  - ___/accounts/views.py
  - ___/accounts/urls.py
  - ___/templates/profile.html
  - ___/templates/registration/password_change.html
autonomous: true

must_haves:
  truths:
    - "User can view profile page with current values pre-filled"
    - "User can update nombre_completo and see change after save"
    - "User can update telefono and see change after save"
    - "User can update referral_goal and see updated goal on home page"
    - "User can change password on separate page"
    - "User stays logged in after password change"
    - "Success toast appears after saving profile or password"
  artifacts:
    - path: "___/accounts/forms.py"
      provides: "ProfileForm and CustomPasswordChangeForm classes"
      contains: "class ProfileForm"
    - path: "___/accounts/views.py"
      provides: "profile_view and CustomPasswordChangeView"
      contains: "def profile_view"
    - path: "___/templates/profile.html"
      provides: "Profile editing UI with cedula read-only, 3 editable fields"
      min_lines: 80
    - path: "___/templates/registration/password_change.html"
      provides: "Password change form UI"
      min_lines: 60
  key_links:
    - from: "___/templates/profile.html"
      to: "profile_view"
      via: "form POST to perfil URL"
      pattern: "method=\"post\""
    - from: "___/accounts/views.py"
      to: "ProfileForm"
      via: "form instance binding"
      pattern: "ProfileForm.*instance=request.user"
    - from: "___/templates/profile.html"
      to: "password_change.html"
      via: "link to password change URL"
      pattern: "url 'password_change'"
---

<objective>
Create the profile editing page and password change page for users to manage their account.

Purpose: PROF-01, PROF-02, PROF-03, PROF-04 - Users need to edit their profile (nombre, telefono, referral goal) and change their password. This replaces the placeholder route at /perfil/ and adds /cambiar-password/.

Output: Working profile page with form, toast feedback, and real-time validation; separate password change page using Django's built-in PasswordChangeView.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-profile-page/09-CONTEXT.md
@.planning/phases/09-profile-page/09-RESEARCH.md
@___/accounts/forms.py
@___/accounts/views.py
@___/accounts/urls.py
@___/templates/home.html
@___/templates/registration/register.html
@___/templates/base.html
@___/accounts/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create profile editing (forms, view, template, URL)</name>
  <files>
    ___/accounts/forms.py
    ___/accounts/views.py
    ___/accounts/urls.py
    ___/templates/profile.html
  </files>
  <action>
    **forms.py - Add ProfileForm:**
    - Create ProfileForm as ModelForm for CustomUser
    - Fields: nombre_completo, phone, referral_goal (NOT cedula - read-only display)
    - Use widgets with Bootstrap classes (form-control)
    - Add labels in Spanish: "Nombre Completo", "Telefono", "Meta de Referidos"
    - Add clean_nombre_completo: letters/accents/spaces only, 2-60 chars (reuse regex from CustomUserCreationForm)
    - Add clean_phone: 10 digits only
    - Add clean_referral_goal: must be >= 0

    **views.py - Add profile_view:**
    - Import messages from django.contrib
    - Import ProfileForm from .forms
    - Create profile_view function with @login_required decorator
    - On GET: Create form with instance=request.user, render profile.html
    - On POST: Bind form with request.POST and instance=request.user
    - If valid: save, add success message "Perfil actualizado correctamente", redirect to 'perfil'
    - If invalid: add error message "Por favor corrige los errores"
    - Pass form and user to template context

    **urls.py - Update perfil route:**
    - Import profile_view
    - Change perfil path from placeholder_view to profile_view
    - Keep name='perfil'

    **templates/profile.html:**
    - Extend base.html
    - Include navbar block (copy from home.html - same nav with Perfil/Referidos/Logout)
    - Centered card layout (col-lg-6 col-md-8) matching home page style
    - Card title: "Mi Perfil"
    - Show cedula as read-only plaintext (form-control-plaintext bg-light)
    - Form fields for nombre_completo, phone, referral_goal with:
      - Bootstrap form-control classes
      - is-invalid class when errors exist
      - invalid-feedback divs for error messages
    - "Cambiar Contrasena" button (btn-outline-secondary) linking to password_change URL
    - "Guardar" submit button (btn-primary w-100) at bottom
    - Toast container for messages (copy pattern from home.html)
    - JavaScript for:
      - Toast initialization on page load (show any Django messages)
      - Debounce function (1500ms, same as register)
      - Input filtering for nombre (letters/accents/spaces only)
      - Input filtering for phone (numbers only, max 10)
      - Real-time validation on input with debounce
      - Validation on blur
  </action>
  <verify>
    1. Run server: cd ___; python manage.py runserver
    2. Login and visit /perfil/
    3. Verify cedula displays as read-only
    4. Verify current values pre-filled for nombre, phone, goal
    5. Edit nombre_completo, save, verify toast appears, value persisted
    6. Edit telefono, save, verify toast appears, value persisted
    7. Edit referral_goal to 20, save, go to home page, verify progress shows "X de 20"
    8. Test input filtering: typing numbers in nombre field should be blocked
    9. Test validation: empty nombre shows error, phone not 10 digits shows error
  </verify>
  <done>
    - User can view /perfil/ with current values pre-filled
    - User can update nombre_completo and see change reflected after save
    - User can update telefono and see change reflected after save
    - User can update referral_goal and see updated goal on home page
    - Toast notification appears on successful save
    - Real-time validation works with input filtering
  </done>
</task>

<task type="auto">
  <name>Task 2: Create password change page</name>
  <files>
    ___/accounts/forms.py
    ___/accounts/views.py
    ___/accounts/urls.py
    ___/templates/registration/password_change.html
  </files>
  <action>
    **forms.py - Add CustomPasswordChangeForm:**
    - Import PasswordChangeForm from django.contrib.auth.forms
    - Create CustomPasswordChangeForm extending PasswordChangeForm
    - In __init__, update field widgets with Bootstrap classes:
      - old_password: form-control, placeholder "Contrasena actual", label "Contrasena Actual"
      - new_password1: form-control, placeholder "Nueva contrasena", label "Nueva Contrasena"
      - new_password2: form-control, placeholder "Confirmar nueva contrasena", label "Confirmar Nueva Contrasena"

    **views.py - Add CustomPasswordChangeView:**
    - Import PasswordChangeView from django.contrib.auth.views
    - Import reverse_lazy from django.urls
    - Import CustomPasswordChangeForm from .forms
    - Create CustomPasswordChangeView extending PasswordChangeView:
      - template_name = 'registration/password_change.html'
      - form_class = CustomPasswordChangeForm
      - success_url = reverse_lazy('perfil')
      - Override form_valid: add success message "Contrasena actualizada correctamente", call super()

    **urls.py - Add password_change route:**
    - Import CustomPasswordChangeView
    - Add path: 'cambiar-password/', CustomPasswordChangeView.as_view(), name='password_change'

    **templates/registration/password_change.html:**
    - Extend base.html
    - Include navbar block (same as profile/home)
    - Centered narrow card (col-lg-5 col-md-6)
    - Card title: "Cambiar Contrasena"
    - Non-field errors alert at top
    - Form with novalidate:
      - old_password field with is-invalid handling
      - new_password1 field with is-invalid handling
      - new_password2 field with is-invalid handling
    - Two buttons at bottom in d-flex gap-2:
      - "Cancelar" (btn-outline-secondary) linking back to perfil
      - "Cambiar Contrasena" (btn-primary) submit
    - NO toast container needed (redirect to profile shows toast there)
  </action>
  <verify>
    1. Run server, login, go to /perfil/
    2. Click "Cambiar Contrasena" button, verify navigates to /cambiar-password/
    3. Submit with wrong old password, verify error displayed
    4. Submit with mismatched new passwords, verify error displayed
    5. Submit with correct old password and matching new passwords
    6. Verify redirect to /perfil/ with success toast
    7. Logout, login with NEW password, verify login succeeds
    8. Verify user was NOT logged out after password change (session preserved)
  </verify>
  <done>
    - Password change page accessible at /cambiar-password/
    - Old password required for change (security)
    - New password must be confirmed (match)
    - User stays logged in after password change
    - Success toast appears on profile page after change
    - User can login with new password
  </done>
</task>

</tasks>

<verification>
**Full flow verification:**
1. Login with test user
2. Visit /perfil/, verify all current values shown
3. Update nombre_completo, save, verify toast and persistence
4. Update telefono, save, verify toast and persistence
5. Update referral_goal to new value, save
6. Visit /home/, verify progress bar shows new goal
7. Return to /perfil/, click "Cambiar Contrasena"
8. Change password successfully
9. Verify redirected to /perfil/ with success toast
10. Visit /home/, navigate around - still logged in
11. Logout
12. Login with NEW password - success
13. Login with OLD password - fails (expected)

**Requirement coverage:**
- PROF-01: nombre_completo editable - Task 1
- PROF-02: telefono editable - Task 1
- PROF-03: password changeable - Task 2
- PROF-04: referral_goal editable - Task 1
</verification>

<success_criteria>
1. Profile page loads at /perfil/ with current user values
2. Cedula displayed as read-only (not editable)
3. Editing nombre_completo and saving persists the change
4. Editing telefono and saving persists the change
5. Editing referral_goal and saving reflects on home page progress
6. Password change works: requires old password, validates new password
7. User stays logged in after password change
8. Toast notifications appear for both profile save and password change
9. Real-time validation with input filtering matches register page patterns
</success_criteria>

<output>
After completion, create `.planning/phases/09-profile-page/09-01-SUMMARY.md`
</output>
