---
phase: 02-authentication-system
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - ___/accounts/forms.py
  - ___/accounts/views.py
  - ___/accounts/urls.py
  - ___/___/urls.py
  - ___/templates/registration/login.html
  - ___/templates/registration/register.html
  - ___/___/settings.py
autonomous: false

must_haves:
  truths:
    - "User can visit /register/ and see registration form with all required fields"
    - "User can submit registration with valid data and account is created"
    - "User can visit /login/ and see username, password, remember me checkbox"
    - "User can login with valid credentials and session is created"
    - "Remember me checkbox controls session expiry (browser close vs 14 days)"
    - "Registration validates cedula format and data policy acceptance"
  artifacts:
    - path: "___/accounts/forms.py"
      provides: "CustomUserCreationForm with cedula validation"
      exports: ["CustomUserCreationForm"]
      min_lines: 20
    - path: "___/accounts/views.py"
      provides: "Registration view and CustomLoginView with remember me"
      exports: ["register", "CustomLoginView"]
      min_lines: 30
    - path: "___/templates/registration/login.html"
      provides: "Login form with remember me checkbox"
      contains: "remember_me"
    - path: "___/templates/registration/register.html"
      provides: "Registration form with all custom fields"
      contains: "cedula"
  key_links:
    - from: "___/accounts/forms.py"
      to: "___/accounts/models.py"
      via: "form references CustomUser model"
      pattern: "model\\s*=\\s*CustomUser"
    - from: "___/accounts/views.py"
      to: "___/accounts/forms.py"
      via: "views use custom forms"
      pattern: "CustomUserCreationForm"
    - from: "___/___/urls.py"
      to: "___/accounts/urls.py"
      via: "URL inclusion"
      pattern: "include\\(['\"]accounts\\.urls['\"]\\)"
    - from: "___/templates/registration/login.html"
      to: "___/accounts/views.py"
      via: "form POST to CustomLoginView"
      pattern: "method=['\"]post['\"]"
---

<objective>
Implement registration and login views with Colombian cedula validation and remember me functionality

Purpose: Enable users to register with custom fields (cedula, nombre_completo, phone, data policy) and login with session persistence control. Forms validate cedula format (6-10 digits) and enforce data policy acceptance.

Output:
- Registration form and view handling CustomUser creation
- Login view with remember me session control
- Templates for login and registration pages
- URL routing for /login/ and /register/
- Session configuration in settings
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-system/02-RESEARCH.md
@.planning/phases/02-authentication-system/02-01-SUMMARY.md
@___/accounts/models.py
@___/___/settings.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CustomUserCreationForm with cedula validation</name>
  <files>___/accounts/forms.py</files>
  <action>
    Create ___/accounts/forms.py with CustomUserCreationForm extending UserCreationForm:

    Imports:
    - from django.contrib.auth.forms import UserCreationForm
    - from django.core.exceptions import ValidationError
    - from .models import CustomUser

    CustomUserCreationForm:
    - Meta.model = CustomUser
    - Meta.fields = ('username', 'password1', 'password2', 'nombre_completo', 'cedula', 'phone', 'data_policy_accepted')
    - Add clean_data_policy_accepted() method:
      * Get cleaned data
      * If not accepted, raise ValidationError('You must accept the data policy to register')
      * Return accepted

    NOTE: Cedula validation is already handled by model validator (validate_cedula). Form will automatically use it via model's validators attribute. No need to duplicate validation logic.

    Follow Pattern 2 from RESEARCH.md for form validation structure.
  </action>
  <verify>
    - File exists: ls ___/accounts/forms.py
    - Check imports: grep "from django.contrib.auth.forms import UserCreationForm" ___/accounts/forms.py
    - Check Meta.fields includes custom fields: grep "cedula" ___/accounts/forms.py
  </verify>
  <done>
    - CustomUserCreationForm exists in forms.py
    - Form includes all required fields (username, passwords, nombre_completo, cedula, phone, data_policy_accepted)
    - clean_data_policy_accepted validates checkbox is checked
    - Form inherits cedula validation from CustomUser model
  </done>
</task>

<task type="auto">
  <name>Task 2: Create registration view and CustomLoginView with remember me</name>
  <files>___/accounts/views.py</files>
  <action>
    Create ___/accounts/views.py with two components:

    1. register(request) function view:
       - Import: from django.shortcuts import render, redirect
       - Import: from django.contrib.auth import login
       - Import: from .forms import CustomUserCreationForm
       - Handle GET: Display empty CustomUserCreationForm
       - Handle POST:
         * Validate form (form.is_valid())
         * Save user (user = form.save())
         * Log user in immediately (login(request, user))
         * Redirect to 'home' (will be created in Phase 3, use try/except to redirect to '/admin/' if 'home' not found)
       - Render 'registration/register.html' with form context

    2. CustomLoginView(LoginView) class:
       - Import: from django.contrib.auth.views import LoginView
       - Set template_name = 'registration/login.html'
       - Override form_valid(self, form):
         * Call parent: response = super().form_valid(form)
         * Get remember_me from POST: remember_me = self.request.POST.get('remember_me')
         * If NOT remember_me: self.request.session.set_expiry(0)  # Expire on browser close
         * Else: self.request.session.set_expiry(1209600)  # 14 days in seconds
         * Return response

    Follow Pattern 3 from RESEARCH.md for remember me implementation. Use set_expiry(0) for browser close, set_expiry(1209600) for 14 days.

    IMPORTANT: Use generic error messages ("Invalid username or password") to avoid account enumeration attacks. Django's LoginView already does this by default - don't override error messages.
  </action>
  <verify>
    - File exists: ls ___/accounts/views.py
    - Check register function: grep "def register" ___/accounts/views.py
    - Check CustomLoginView: grep "class CustomLoginView" ___/accounts/views.py
    - Check set_expiry usage: grep "set_expiry" ___/accounts/views.py
  </verify>
  <done>
    - register view handles GET/POST for registration
    - register logs user in immediately after successful registration
    - CustomLoginView extends LoginView
    - form_valid checks remember_me checkbox
    - Session expiry set to 0 (browser close) or 1209600 (14 days)
  </done>
</task>

<task type="auto">
  <name>Task 3: Create URL routing and templates</name>
  <files>
    ___/accounts/urls.py
    ___/___/urls.py
    ___/templates/registration/login.html
    ___/templates/registration/register.html
    ___/___/settings.py
  </files>
  <action>
    1. Create ___/accounts/urls.py:
       - from django.urls import path
       - from .views import register, CustomLoginView
       - from django.contrib.auth.views import LogoutView
       - urlpatterns = [
           path('register/', register, name='register'),
           path('login/', CustomLoginView.as_view(), name='login'),
           path('logout/', LogoutView.as_view(), name='logout'),
         ]

    2. Update ___/___/urls.py:
       - Add: from django.urls import path, include
       - Add to urlpatterns: path('', include('accounts.urls'))
       - Keep existing admin.site.urls

    3. Configure settings.py:
       - Update TEMPLATES DIRS to include templates folder: 'DIRS': [BASE_DIR / 'templates']
       - Add LOGIN_URL = '/login/' at bottom
       - Add LOGIN_REDIRECT_URL = '/admin/' at bottom (temporary, will change to '/home/' in Phase 3)
       - Add LOGOUT_REDIRECT_URL = '/login/' at bottom
       - Add session configuration:
         SESSION_COOKIE_AGE = 1209600  # 2 weeks
         SESSION_EXPIRE_AT_BROWSER_CLOSE = False  # Let views control via set_expiry()
         SESSION_SAVE_EVERY_REQUEST = False  # Performance
         SESSION_COOKIE_HTTPONLY = True  # Security
         SESSION_COOKIE_SAMESITE = 'Lax'  # CSRF protection

    4. Create ___/templates/registration/login.html:
       - Basic HTML structure with form
       - {% csrf_token %}
       - {{ form.as_p }} for username and password fields
       - <input type="checkbox" name="remember_me" value="1"> Remember me
       - Submit button
       - Link to register: <a href="{% url 'register' %}">Create account</a>

    5. Create ___/templates/registration/register.html:
       - Basic HTML structure with form
       - {% csrf_token %}
       - {{ form.as_p }} for all fields (username, passwords, nombre_completo, cedula, phone, data_policy_accepted)
       - Submit button
       - Link to login: <a href="{% url 'login' %}">Already have an account?</a>

    IMPORTANT: Follow RESEARCH.md Pattern 4 for session configuration. Use SESSION_COOKIE_HTTPONLY=True and SESSION_COOKIE_SAMESITE='Lax' for security (CSRF protection).

    Templates are minimal HTML for now - no CSS styling. Phase 3 or later can add styling.
  </action>
  <verify>
    - Files exist:
      ls ___/accounts/urls.py
      ls ___/templates/registration/login.html
      ls ___/templates/registration/register.html
    - Check URL inclusion: grep "include('accounts.urls')" ___/___/urls.py
    - Check TEMPLATES DIRS: grep "BASE_DIR / 'templates'" ___/___/settings.py
    - Check LOGIN_URL: grep "LOGIN_URL" ___/___/settings.py
    - Check session config: grep "SESSION_COOKIE_AGE" ___/___/settings.py
  </verify>
  <done>
    - URL routing configured for /login/, /register/, /logout/
    - Templates exist in Django's expected location (templates/registration/)
    - Login template has username, password, remember me checkbox
    - Register template has all custom fields
    - settings.py has LOGIN_URL, LOGIN_REDIRECT_URL, LOGOUT_REDIRECT_URL
    - Session configuration added to settings.py
    - TEMPLATES DIRS includes BASE_DIR / 'templates'
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Registration and login forms with Colombian cedula validation and remember me functionality
  </what-built>
  <how-to-verify>
    1. Start server: python ___/manage.py runserver
    2. Visit http://127.0.0.1:8000/register/
       - Verify form shows: username, password1, password2, nombre_completo, cedula, phone, data_policy_accepted
       - Try registering with invalid cedula (e.g., "123" - too short): Should show validation error
       - Try registering without accepting data policy: Should show validation error
       - Register valid user:
         * Username: testuser
         * Password: TestPass123!
         * Nombre Completo: Juan PÃ©rez
         * Cedula: 123456 (6 digits valid)
         * Phone: 3001234567
         * Data policy: checked
       - Should redirect to /admin/ and be logged in
    3. Logout: Visit http://127.0.0.1:8000/logout/
       - Should redirect to /login/
    4. Visit http://127.0.0.1:8000/login/
       - Verify form shows: username, password, remember me checkbox
       - Login with testuser / TestPass123! WITHOUT checking remember me
       - Should redirect to /admin/ and be logged in
       - Check session expiry: Close browser, reopen - session should expire
    5. Login again WITH remember me checked
       - Should redirect to /admin/ and be logged in
       - Check session persists: Close browser, reopen - session should persist
    6. Test cedula validation on existing user:
       - Visit /admin/accounts/customuser/
       - Click "Add user"
       - Try adding user with invalid cedula (e.g., "abc123"): Should reject
       - Try adding user with valid cedula (e.g., "9876543210" - 10 digits): Should accept
  </how-to-verify>
  <resume-signal>
    Type "approved" if all verifications pass, or describe any issues found
  </resume-signal>
</task>

</tasks>

<verification>
Automated verification before checkpoint:

1. URL routing check:
   ```bash
   python ___/manage.py show_urls 2>/dev/null || python ___/manage.py shell -c "
   from django.urls import get_resolver
   resolver = get_resolver()
   for pattern in resolver.url_patterns:
       print(pattern)
   "
   ```
   Should include login, register, logout URLs

2. Template existence:
   ```bash
   ls ___/templates/registration/login.html
   ls ___/templates/registration/register.html
   ```
   Both should exist

3. Settings check:
   ```bash
   grep "LOGIN_URL" ___/___/settings.py
   grep "SESSION_COOKIE_AGE" ___/___/settings.py
   ```
   Should find LOGIN_URL and session settings

4. Form validation test:
   ```bash
   python ___/manage.py shell -c "
   from accounts.forms import CustomUserCreationForm

   # Test form with invalid cedula
   data = {
       'username': 'test',
       'password1': 'TestPass123!',
       'password2': 'TestPass123!',
       'nombre_completo': 'Test User',
       'cedula': '123',  # Too short
       'phone': '3001234567',
       'data_policy_accepted': True
   }
   form = CustomUserCreationForm(data)
   if form.is_valid():
       print('ERROR: Form accepted invalid cedula')
   else:
       print('PASS: Form rejected invalid cedula')
       print('Errors:', form.errors)
   "
   ```
</verification>

<success_criteria>
Measurable completion state:

1. **Registration works**: User can register at /register/ with all custom fields
2. **Cedula validation enforced**: Invalid cedula (wrong length, letters) rejected by form
3. **Data policy required**: Registration fails if checkbox not checked
4. **Login works**: User can login at /login/ with username/password
5. **Remember me functional**: Checkbox controls session expiry (0 vs 1209600 seconds)
6. **Immediate login**: User logged in automatically after registration
7. **URLs configured**: /login/, /register/, /logout/ accessible
8. **Templates render**: Login and register pages display correctly
9. **Session security**: SESSION_COOKIE_HTTPONLY=True, SESSION_COOKIE_SAMESITE='Lax'

**Requirements satisfied:**
- AUTH-01: Complete registration with all required fields
- AUTH-02: Colombian cedula validation (6-10 digits)
- AUTH-03: User can log in with username and password
- AUTH-04: "Remember me" option extends session duration
- PAGE-01: Login page with username, password, remember me
- PAGE-02: Registration page with all required fields
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-system/02-02-SUMMARY.md` following the summary template.

Include in summary:
- Decision: Why set_expiry(0) vs set_expiry(1209600) for remember me (research showed integer = seconds of inactivity)
- Pattern established: Form validation delegates to model validators (DRY principle)
- Key insight: Immediate login after registration improves UX
- Session security settings: HTTPONLY, SAMESITE for CSRF protection
</output>
