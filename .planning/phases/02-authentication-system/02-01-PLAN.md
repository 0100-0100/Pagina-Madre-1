---
phase: 02-authentication-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ___/accounts/models.py
  - ___/accounts/admin.py
  - ___/accounts/__init__.py
  - ___/___/settings.py
autonomous: true

must_haves:
  truths:
    - "CustomUser model exists with cedula, nombre_completo, phone, data_policy_accepted fields"
    - "Cedula accepts 6-10 digits and rejects invalid formats"
    - "AUTH_USER_MODEL points to accounts.CustomUser"
    - "Admin interface displays custom user fields"
    - "Database has accounts_customuser table, not auth_user"
  artifacts:
    - path: "___/accounts/models.py"
      provides: "CustomUser model extending AbstractUser"
      exports: ["CustomUser", "validate_cedula"]
      min_lines: 30
    - path: "___/accounts/admin.py"
      provides: "Admin registration for CustomUser"
      exports: ["CustomUserAdmin"]
      min_lines: 15
    - path: "___/___/settings.py"
      contains: "AUTH_USER_MODEL = 'accounts.CustomUser'"
  key_links:
    - from: "___/accounts/models.py"
      to: "django.contrib.auth.models.AbstractUser"
      via: "class inheritance"
      pattern: "class CustomUser\\(AbstractUser\\)"
    - from: "___/___/settings.py"
      to: "accounts.CustomUser"
      via: "AUTH_USER_MODEL setting"
      pattern: "AUTH_USER_MODEL\\s*=\\s*['\"]accounts\\.CustomUser['\"]"
    - from: "___/accounts/admin.py"
      to: "___/accounts/models.py"
      via: "model registration"
      pattern: "admin\\.site\\.register\\(CustomUser"
---

<objective>
Create custom user model with Colombian cedula validation and admin integration

Purpose: Extend Django's built-in user model with custom fields (Nombre Completo, Cedula, Phone, data policy acceptance) while preserving all default authentication functionality. CRITICAL: Must be completed before any auth migrations are run.

Output:
- accounts app with CustomUser model
- Cedula validator (6-10 digits)
- Admin interface for user management
- AUTH_USER_MODEL configured in settings
- Initial migration creating accounts_customuser table
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-system/02-RESEARCH.md
@___/___/settings.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create accounts app with CustomUser model</name>
  <files>
    ___/accounts/models.py
    ___/accounts/__init__.py
    ___/___/settings.py
  </files>
  <action>
    Create accounts app using `python ___/manage.py startapp accounts`.

    In ___/accounts/models.py, create:
    - validate_cedula(value) function: Validates Colombian cedula format (6-10 digits only, no letters/special chars). Raises ValidationError if not digits or wrong length.
    - CustomUser(AbstractUser) model with fields:
      - cedula: CharField(max_length=10, unique=True, validators=[validate_cedula], help_text='Colombian cedula (6-10 digits)')
      - nombre_completo: CharField(max_length=200, verbose_name='Nombre Completo')
      - phone: CharField(max_length=20, verbose_name='Teléfono')
      - data_policy_accepted: BooleanField(default=False, verbose_name='Acepto la política de datos')
    - __str__ method returning self.username

    In ___/___/settings.py:
    - Add 'accounts' to INSTALLED_APPS (before django.contrib.auth to ensure proper loading)
    - Add AUTH_USER_MODEL = 'accounts.CustomUser' at bottom of file

    CRITICAL TIMING: This must be done BEFORE running any migrations. Research warns that changing AUTH_USER_MODEL after migrations requires manual schema fixes (4-8+ hours).
  </action>
  <verify>
    - Run: python ___/manage.py check
    - Confirm no errors
    - Grep settings.py for AUTH_USER_MODEL: grep "AUTH_USER_MODEL" ___/___/settings.py
    - Should return: AUTH_USER_MODEL = 'accounts.CustomUser'
  </verify>
  <done>
    - accounts app exists in ___/accounts/
    - CustomUser model defined with all 4 custom fields
    - validate_cedula function validates 6-10 digit format
    - AUTH_USER_MODEL configured in settings.py
    - django check passes without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure admin interface for CustomUser</name>
  <files>___/accounts/admin.py</files>
  <action>
    In ___/accounts/admin.py, create CustomUserAdmin(UserAdmin):
    - Import: from django.contrib.auth.admin import UserAdmin
    - Import: from .models import CustomUser
    - Add custom fields to list_display: list_display = UserAdmin.list_display + ('cedula', 'phone', 'data_policy_accepted')
    - Add fieldsets for viewing existing users:
      fieldsets = UserAdmin.fieldsets + (
        ('Additional Info', {'fields': ('cedula', 'nombre_completo', 'phone', 'data_policy_accepted')}),
      )
    - Add add_fieldsets for creating new users via admin:
      add_fieldsets = UserAdmin.add_fieldsets + (
        ('Additional Info', {'fields': ('cedula', 'nombre_completo', 'phone', 'data_policy_accepted')}),
      )
    - Register: admin.site.register(CustomUser, CustomUserAdmin)

    Follow Pattern 5 from RESEARCH.md exactly to ensure proper admin integration.
  </action>
  <verify>
    - Run: python ___/manage.py check
    - Confirm no admin-related errors
    - Check admin.py imports CustomUser: grep "from .models import CustomUser" ___/accounts/admin.py
  </verify>
  <done>
    - CustomUserAdmin extends UserAdmin with custom fields
    - list_display includes cedula, phone, data_policy_accepted
    - fieldsets and add_fieldsets include custom fields
    - Admin registration complete
  </done>
</task>

<task type="auto">
  <name>Task 3: Create and run initial migrations</name>
  <files>___/accounts/migrations/0001_initial.py</files>
  <action>
    Create initial migration for CustomUser model:
    1. Run: python ___/manage.py makemigrations accounts
    2. Verify migration file created in ___/accounts/migrations/0001_initial.py
    3. Run: python ___/manage.py migrate
    4. Verify accounts_customuser table created (NOT auth_user)

    This creates the custom user table in the database. Since we configured AUTH_USER_MODEL before any migrations, Django creates accounts_customuser instead of auth_user.

    WARNING: If migration fails with "auth.User already exists" error, this means AUTH_USER_MODEL was set too late. This should NOT happen since Phase 1 only ran initial Django migrations (admin, sessions, contenttypes) which don't create auth_user table yet.
  </action>
  <verify>
    - Run: python ___/manage.py showmigrations accounts
    - Confirm 0001_initial is applied (marked with [X])
    - Check database has correct table: python ___/manage.py shell -c "from django.contrib.auth import get_user_model; print(get_user_model()._meta.db_table)"
    - Should output: accounts_customuser
  </verify>
  <done>
    - Migration file 0001_initial.py exists in ___/accounts/migrations/
    - Migration applied successfully
    - Database contains accounts_customuser table with cedula, nombre_completo, phone, data_policy_accepted columns
    - get_user_model() returns CustomUser, not default User
  </done>
</task>

</tasks>

<verification>
Run comprehensive checks:

1. Model validation:
   ```bash
   python ___/manage.py shell -c "
   from accounts.models import CustomUser, validate_cedula
   from django.core.exceptions import ValidationError

   # Test validator accepts valid cedula
   validate_cedula('123456')  # 6 digits - should pass
   validate_cedula('1234567890')  # 10 digits - should pass

   # Test validator rejects invalid cedula
   try:
       validate_cedula('12345')  # 5 digits - should fail
       print('ERROR: Validator accepted 5 digits')
   except ValidationError:
       print('PASS: Validator rejected 5 digits')

   try:
       validate_cedula('12345678901')  # 11 digits - should fail
       print('ERROR: Validator accepted 11 digits')
   except ValidationError:
       print('PASS: Validator rejected 11 digits')

   try:
       validate_cedula('123abc')  # letters - should fail
       print('ERROR: Validator accepted letters')
   except ValidationError:
       print('PASS: Validator rejected letters')

   print('CustomUser model:', CustomUser)
   print('Fields:', [f.name for f in CustomUser._meta.fields])
   "
   ```

2. Settings check:
   ```bash
   grep "AUTH_USER_MODEL" ___/___/settings.py
   ```
   Should output: AUTH_USER_MODEL = 'accounts.CustomUser'

3. Migration check:
   ```bash
   python ___/manage.py showmigrations accounts
   ```
   Should show [X] 0001_initial

4. Database table check:
   ```bash
   python ___/manage.py dbshell -c ".tables" | grep accounts_customuser
   ```
   Should find accounts_customuser table
</verification>

<success_criteria>
Measurable completion state:

1. **Model exists**: CustomUser model in ___/accounts/models.py extends AbstractUser
2. **Custom fields present**: cedula, nombre_completo, phone, data_policy_accepted fields exist
3. **Validation works**: validate_cedula accepts 6-10 digits, rejects other formats
4. **AUTH_USER_MODEL configured**: settings.py contains AUTH_USER_MODEL = 'accounts.CustomUser'
5. **Admin integration**: CustomUserAdmin registered, custom fields visible in list_display and fieldsets
6. **Migration applied**: accounts_customuser table exists in database
7. **No auth_user table**: Database uses accounts_customuser, not default auth_user

**Requirements satisfied:**
- AUTH-01 (partial): Model supports Nombre Completo, Cedula, Phone, data_policy_accepted fields
- AUTH-02: Colombian cedula validation (6-10 digits format)
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-system/02-01-SUMMARY.md` following the summary template.

Include in summary:
- Decision: Why AbstractUser chosen over AbstractBaseUser (preserves username/password auth, admin, permissions)
- Pattern established: Custom user model pattern for future field additions
- Key files: models.py, admin.py, settings.py
- Migration timing: AUTH_USER_MODEL set before first auth migration
</output>
