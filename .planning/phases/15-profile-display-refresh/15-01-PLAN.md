---
phase: 15-profile-display-refresh
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ___/templates/base.html
  - ___/templates/partials/_census_section.html
  - ___/templates/profile.html
  - ___/accounts/views.py
  - ___/accounts/urls.py
  - ___/___/settings.py
autonomous: true

must_haves:
  truths:
    - "User sees census status badge on their profile (pending, found, error states)"
    - "User sees voting location details when status is ACTIVE"
    - "Profile page auto-refreshes census section while status is PENDING/PROCESSING"
    - "Polling stops when status reaches final state (ACTIVE, ERROR, NOT_FOUND, etc.)"
  artifacts:
    - path: "___/templates/partials/_census_section.html"
      provides: "HTMX-swappable census display partial"
      min_lines: 40
    - path: "___/templates/base.html"
      provides: "HTMX script loaded globally"
      contains: "htmx.org"
    - path: "___/accounts/views.py"
      provides: "census_section_view function"
      exports: ["census_section_view"]
  key_links:
    - from: "___/templates/profile.html"
      to: "partials/_census_section.html"
      via: "include tag"
      pattern: "include.*_census_section"
    - from: "___/templates/partials/_census_section.html"
      to: "/censo/"
      via: "hx-get URL"
      pattern: "hx-get.*censo"
---

<objective>
Display census data on user profile with HTMX auto-refresh polling.

Purpose: Users need to see their cedula validation status and voting location after registration. The profile page should show real-time updates as the background task processes.
Output: Profile page with "Datos Electorales" section showing status badge, voting location (when available), and auto-polling for pending states.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-profile-display-refresh/15-CONTEXT.md
@.planning/phases/15-profile-display-refresh/15-RESEARCH.md
@___/accounts/models.py
@___/accounts/views.py
@___/templates/profile.html
@___/templates/base.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add HTMX + humanize and create census section partial</name>
  <files>
    ___/templates/base.html
    ___/templates/partials/_census_section.html
    ___/___/settings.py
  </files>
  <action>
1. Update base.html to add HTMX script after Bootstrap JS:
```html
<script src="https://unpkg.com/htmx.org@2.0.4"
        integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+"
        crossorigin="anonymous"></script>
```

2. Add `django.contrib.humanize` to INSTALLED_APPS in settings.py (for naturaltime filter).

3. Create `___/templates/partials/` directory and `_census_section.html` partial:

The partial must:
- Load humanize template tag
- Have outer div with `id="census-section"`
- Use `hx-get` pointing to `{% url 'census_section' %}`
- Use `hx-trigger="every 5s [document.querySelector('#census-status').dataset.polling === 'true']"` for conditional polling
- Use `hx-swap="outerHTML"` to replace entire section

Status display logic (Spanish text):
- PENDING/PROCESSING: Spinner + "Verificando cedula..." + data-polling="true"
- ACTIVE: Green badge "Verificado" + voting location fields stacked
- NOT_FOUND: Orange badge "No encontrado" + "Cedula no registrada en el censo electoral"
- CANCELLED_DECEASED: Gray badge "Cancelada" + "Cedula cancelada - Fallecido"
- CANCELLED_OTHER: Gray badge "Cancelada" + novedad if available
- ERROR/TIMEOUT/BLOCKED: Red badge "Error" + error_message

Voting location display (when ACTIVE):
- Section title: "Datos Electorales"
- Fields: Departamento, Municipio, Puesto de votacion, Direccion (stacked, labeled)
- Show timestamp: "Verificado: {{ cedula_info.fetched_at|naturaltime }}"

For non-pending states, set data-polling="false" to stop polling.

Handle case where cedula_info is None (show "Sin informacion").
  </action>
  <verify>
- File exists: `ls ___/templates/partials/_census_section.html`
- HTMX in base: `grep -q "htmx.org" ___/templates/base.html && echo "OK"`
- humanize in settings: `grep -q "humanize" ___/___/settings.py && echo "OK"`
  </verify>
  <done>
- HTMX 2.0.4 script tag present in base.html
- django.contrib.humanize added to INSTALLED_APPS
- _census_section.html partial exists with all 9 status states handled
- Conditional polling via data-polling attribute
  </done>
</task>

<task type="auto">
  <name>Task 2: Create census section view and integrate into profile</name>
  <files>
    ___/accounts/views.py
    ___/accounts/urls.py
    ___/templates/profile.html
  </files>
  <action>
1. In views.py, add `census_section_view`:
```python
@login_required
def census_section_view(request):
    """Return census section partial for HTMX polling."""
    cedula_info = getattr(request.user, 'cedula_info', None)

    # Determine if polling should continue
    is_polling = False
    if cedula_info:
        is_polling = cedula_info.status in [
            CedulaInfo.Status.PENDING,
            CedulaInfo.Status.PROCESSING
        ]

    return render(request, 'partials/_census_section.html', {
        'cedula_info': cedula_info,
        'is_polling': is_polling,
        'user': request.user,
    })
```

Import CedulaInfo from .models at top of file.

2. In urls.py, add route:
```python
path('censo/', census_section_view, name='census_section'),
```

Import census_section_view in the views import statement.

3. In profile.html:
- Add `{% load humanize %}` at top after extends
- After the "Cambiar Contrasena" button section (before Submit), add a new card section:
```html
<!-- Datos Electorales Section -->
<div class="card mt-4">
    <div class="card-body">
        <h5 class="card-title mb-3">
            <i class="bi bi-geo-alt"></i> Datos Electorales
        </h5>
        {% include 'partials/_census_section.html' %}
    </div>
</div>
```

Pass cedula_info and is_polling to template context in profile_view (get from user.cedula_info).
  </action>
  <verify>
Run dev server and test:
```bash
cd ___
python manage.py runserver &
sleep 2
curl -s http://127.0.0.1:8000/censo/ -H "Cookie: sessionid=..." | grep -q "census-section" && echo "View OK"
```

Manual verification: Log in and visit /perfil/ - should see "Datos Electorales" section.
  </verify>
  <done>
- census_section_view exists and returns partial template
- URL /censo/ mapped to census_section_view
- profile.html includes census section partial
- profile_view passes cedula_info to context
- HTMX polling works when status is PENDING/PROCESSING
  </done>
</task>

</tasks>

<verification>
1. Start dev server: `cd ___ && python manage.py runserver`
2. Log in as existing user
3. Visit /perfil/ - should see "Datos Electorales" section
4. If user has CedulaInfo with PENDING status, section should poll every 5s (visible in Network tab)
5. If user has ACTIVE status, voting location details visible, no polling
6. If user has error status, appropriate badge and message shown
</verification>

<success_criteria>
- [ ] HTMX 2.0.4 loaded in base.html
- [ ] humanize app enabled for naturaltime filter
- [ ] _census_section.html handles all 9 CedulaInfo statuses
- [ ] /censo/ endpoint returns partial for HTMX
- [ ] profile.html displays census section
- [ ] Polling active only for PENDING/PROCESSING states
- [ ] Polling stops for final states (ACTIVE, ERROR, NOT_FOUND, etc.)
</success_criteria>

<output>
After completion, create `.planning/phases/15-profile-display-refresh/15-01-SUMMARY.md`
</output>
