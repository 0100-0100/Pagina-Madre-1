---
phase: 15-profile-display-refresh
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - ___/accounts/decorators.py
  - ___/accounts/views.py
  - ___/accounts/urls.py
  - ___/templates/partials/_census_section.html
  - ___/templates/profile.html
autonomous: true

must_haves:
  truths:
    - "Leaders see refresh button in census section"
    - "Regular users do NOT see refresh button"
    - "Clicking refresh triggers validation task and shows spinner"
    - "Refresh button has 30-second server-side cooldown"
    - "Leaders can refresh their own data"
    - "Leaders can refresh data for users they referred"
    - "Regular users cannot trigger refresh for other users (403 response)"
  artifacts:
    - path: "___/accounts/decorators.py"
      provides: "leader_or_self_required decorator for RBAC"
      min_lines: 15
    - path: "___/accounts/views.py"
      provides: "refresh_cedula_view function"
      exports: ["refresh_cedula_view"]
  key_links:
    - from: "___/templates/partials/_census_section.html"
      to: "/refrescar-cedula/"
      via: "hx-post URL"
      pattern: "hx-post.*refrescar-cedula"
    - from: "___/accounts/views.py"
      to: "accounts.tasks.validate_cedula"
      via: "async_task import"
      pattern: "async_task.*validate_cedula"
---

<objective>
Add leader-only refresh button with RBAC enforcement and rate limiting.

Purpose: Leaders need to manually trigger cedula validation refresh for themselves and their referrals when data is stale or errored. Security requires that regular users cannot refresh other users' data.
Output: Refresh button visible only to leaders, triggering async task with 30s cooldown, proper 403 responses for unauthorized access.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-profile-display-refresh/15-CONTEXT.md
@.planning/phases/15-profile-display-refresh/15-RESEARCH.md
@.planning/phases/15-profile-display-refresh/15-01-SUMMARY.md
@___/accounts/models.py
@___/accounts/views.py
@___/accounts/tasks.py
@___/templates/partials/_census_section.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RBAC decorator and refresh view</name>
  <files>
    ___/accounts/decorators.py
    ___/accounts/views.py
    ___/accounts/urls.py
  </files>
  <action>
1. Create `___/accounts/decorators.py` with `leader_or_self_required` decorator:

```python
from functools import wraps
from django.http import HttpResponseForbidden

def leader_or_self_required(view_func):
    """
    Decorator that allows access if:
    - user_id is None (viewing own data)
    - user_id matches request.user.id (viewing own data)
    - request.user is LEADER and target user was referred by them
    """
    @wraps(view_func)
    def _wrapped_view(request, user_id=None, *args, **kwargs):
        from .models import CustomUser

        # Self-access always allowed
        if user_id is None or user_id == request.user.id:
            return view_func(request, user_id, *args, **kwargs)

        # Leader accessing referral
        if request.user.role == CustomUser.Role.LEADER:
            target_user = CustomUser.objects.filter(id=user_id).first()
            if target_user and target_user.referred_by_id == request.user.id:
                return view_func(request, user_id, *args, **kwargs)

        return HttpResponseForbidden("No tienes permiso para esta accion.")
    return _wrapped_view
```

2. In views.py, add `refresh_cedula_view`:

```python
from datetime import timedelta
from django.utils import timezone
from django_q.tasks import async_task
from .decorators import leader_or_self_required

@login_required
@leader_or_self_required
def refresh_cedula_view(request, user_id=None):
    """Trigger cedula validation refresh (leader only)."""
    # Determine target user
    if user_id is None:
        target_user = request.user
    else:
        target_user = CustomUser.objects.filter(id=user_id).first()
        if not target_user:
            return HttpResponseForbidden("Usuario no encontrado.")

    cedula_info = getattr(target_user, 'cedula_info', None)

    # Rate limiting: 30 second cooldown
    if cedula_info and cedula_info.fetched_at:
        cooldown_until = cedula_info.fetched_at + timedelta(seconds=30)
        if timezone.now() < cooldown_until:
            # Return current section with error message via HX-Trigger
            response = render(request, 'partials/_census_section.html', {
                'cedula_info': cedula_info,
                'is_polling': False,
                'user': target_user,
                'is_leader': request.user.role == CustomUser.Role.LEADER,
                'show_refresh': True,
            })
            response['HX-Trigger'] = '{"showToast": {"message": "Espera 30 segundos antes de actualizar de nuevo", "type": "warning"}}'
            return response

    # Set status to PROCESSING immediately (avoid race condition)
    if cedula_info:
        cedula_info.status = CedulaInfo.Status.PROCESSING
        cedula_info.fetched_at = timezone.now()  # Reset for cooldown
        cedula_info.save(update_fields=['status', 'fetched_at'])

    # Queue async task
    async_task('accounts.tasks.validate_cedula', target_user.id, 1)

    # Return updated section
    response = render(request, 'partials/_census_section.html', {
        'cedula_info': cedula_info,
        'is_polling': True,
        'user': target_user,
        'is_leader': request.user.role == CustomUser.Role.LEADER,
        'show_refresh': True,
    })
    response['HX-Trigger'] = '{"showToast": {"message": "Actualizacion en progreso", "type": "info"}}'
    return response
```

Import needed modules at top: `from datetime import timedelta`, `from django.utils import timezone`, `from django_q.tasks import async_task`.

3. In urls.py, add routes:
```python
path('refrescar-cedula/', refresh_cedula_view, name='refresh_cedula'),
path('refrescar-cedula/<int:user_id>/', refresh_cedula_view, name='refresh_cedula_user'),
```

Import refresh_cedula_view in the views import statement.
  </action>
  <verify>
```bash
# Check decorator exists
test -f ___/accounts/decorators.py && echo "Decorator file exists"

# Check view exists
grep -q "refresh_cedula_view" ___/accounts/views.py && echo "View exists"

# Check URL routes
grep -q "refrescar-cedula" ___/accounts/urls.py && echo "URL exists"
```
  </verify>
  <done>
- decorators.py created with leader_or_self_required
- refresh_cedula_view handles self-refresh and referral-refresh
- 30-second cooldown enforced server-side
- Status set to PROCESSING before returning (race condition fix)
- async_task queued for validate_cedula
- HX-Trigger header sends toast messages
  </done>
</task>

<task type="auto">
  <name>Task 2: Add refresh button to census section with HTMX + toast handler</name>
  <files>
    ___/templates/partials/_census_section.html
    ___/templates/profile.html
  </files>
  <action>
1. Update `_census_section.html` to add refresh button (visible only to leaders):

After the status display but inside the census-section div, add:

```html
{% if show_refresh and is_leader %}
<div class="mt-3">
    <button hx-post="{% url 'refresh_cedula' %}"
            hx-target="#census-section"
            hx-swap="outerHTML"
            hx-disabled-elt="this"
            hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
            class="btn btn-sm btn-outline-secondary">
        <span class="htmx-indicator">
            <span class="spinner-border spinner-border-sm" role="status"></span>
        </span>
        <span class="htmx-indicator-hide">
            <i class="bi bi-arrow-clockwise"></i>
        </span>
        Actualizar
    </button>
</div>
{% endif %}
```

Add CSS for htmx-indicator in the partial or profile:
```html
<style>
    .htmx-indicator { display: none; }
    .htmx-request .htmx-indicator { display: inline; }
    .htmx-request .htmx-indicator-hide { display: none; }
</style>
```

2. Update `profile_view` in views.py to pass additional context:

```python
@login_required
def profile_view(request):
    """Profile editing view."""
    cedula_info = getattr(request.user, 'cedula_info', None)
    is_polling = False
    if cedula_info:
        is_polling = cedula_info.status in [
            CedulaInfo.Status.PENDING,
            CedulaInfo.Status.PROCESSING
        ]

    if request.method == 'POST':
        form = ProfileForm(request.POST, instance=request.user)
        if form.is_valid():
            form.save()
            messages.success(request, 'Perfil actualizado correctamente')
            return redirect('perfil')
        else:
            messages.error(request, 'Por favor corrige los errores')
    else:
        form = ProfileForm(instance=request.user)

    return render(request, 'profile.html', {
        'form': form,
        'user': request.user,
        'cedula_info': cedula_info,
        'is_polling': is_polling,
        'is_leader': request.user.role == CustomUser.Role.LEADER,
        'show_refresh': True,  # On own profile, always show if leader
    })
```

3. Update `census_section_view` to also pass is_leader and show_refresh:

```python
@login_required
def census_section_view(request):
    """Return census section partial for HTMX polling."""
    cedula_info = getattr(request.user, 'cedula_info', None)
    is_polling = False
    if cedula_info:
        is_polling = cedula_info.status in [
            CedulaInfo.Status.PENDING,
            CedulaInfo.Status.PROCESSING
        ]

    return render(request, 'partials/_census_section.html', {
        'cedula_info': cedula_info,
        'is_polling': is_polling,
        'user': request.user,
        'is_leader': request.user.role == CustomUser.Role.LEADER,
        'show_refresh': True,
    })
```

4. Add toast handler JavaScript to profile.html in extra_js block:

```javascript
// Handle HTMX showToast events
document.body.addEventListener('showToast', function(evt) {
    const toastEl = document.getElementById('profileToast');
    const toastBody = document.getElementById('toastMessage');
    if (toastEl && toastBody) {
        toastBody.textContent = evt.detail.message;
        const header = toastEl.querySelector('.toast-header i');
        if (evt.detail.type === 'warning') {
            header.className = 'bi bi-exclamation-triangle text-warning me-2';
        } else if (evt.detail.type === 'info') {
            header.className = 'bi bi-info-circle text-info me-2';
        } else {
            header.className = 'bi bi-check-circle text-success me-2';
        }
        const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
        toast.show();
    }
});
```

Import CustomUser.Role at top of views.py if not already imported.
  </action>
  <verify>
```bash
# Check refresh button in template
grep -q "refrescar-cedula" ___/templates/partials/_census_section.html && echo "Refresh button OK"

# Check toast handler
grep -q "showToast" ___/templates/profile.html && echo "Toast handler OK"

# Check is_leader passed to template
grep -q "is_leader" ___/accounts/views.py && echo "Context OK"
```
  </verify>
  <done>
- Refresh button visible only when is_leader is true
- Button uses HTMX POST with CSRF token
- Button disables during request (hx-disabled-elt)
- Spinner shows during request
- Toast handler listens for showToast events
- Toast displays warning/info messages from HX-Trigger
  </done>
</task>

<task type="auto">
  <name>Task 3: Test RBAC enforcement end-to-end</name>
  <files>None (verification only)</files>
  <action>
Create a test script to verify RBAC works correctly:

1. Via Django shell, verify decorator logic:
```python
# Test 1: Regular user cannot access refresh for other user
from django.test import RequestFactory
from django.contrib.auth import get_user_model
from accounts.views import refresh_cedula_view

User = get_user_model()
factory = RequestFactory()

# Create test users
leader = User.objects.create_user(username='12345678', password='test123', role='LEADER')
referral = User.objects.create_user(username='87654321', password='test123', referred_by=leader)
other_user = User.objects.create_user(username='11111111', password='test123')

# Test: Regular user trying to refresh other user (should fail)
request = factory.post('/refrescar-cedula/{}/'.format(referral.id))
request.user = other_user
# This should return 403

# Test: Leader refreshing referral (should succeed)
request = factory.post('/refrescar-cedula/{}/'.format(referral.id))
request.user = leader
# This should succeed

# Test: Leader refreshing non-referral (should fail)
request = factory.post('/refrescar-cedula/{}/'.format(other_user.id))
request.user = leader
# This should return 403
```

2. Manual browser testing:
- Log in as regular USER, verify no refresh button visible
- Log in as LEADER, verify refresh button visible
- As LEADER, click refresh, verify spinner appears and task queues
- Check Django-Q admin for queued task
  </action>
  <verify>
Manual verification steps:
1. Create LEADER user via admin if not exists
2. Log in as LEADER at /login/
3. Visit /perfil/ - refresh button should be visible
4. Click "Actualizar" - button should show spinner, toast should appear
5. Log in as regular USER
6. Visit /perfil/ - refresh button should NOT be visible
  </verify>
  <done>
- Regular users cannot see refresh button
- Leaders can see and use refresh button
- RBAC decorator correctly blocks unauthorized access
- Rate limiting (30s) enforced server-side
  </done>
</task>

</tasks>

<verification>
1. RBAC Test: Log in as regular user -> no refresh button on /perfil/
2. RBAC Test: Log in as leader -> refresh button visible on /perfil/
3. Refresh Test: Click button -> spinner, toast "Actualizacion en progreso", status changes to PROCESSING
4. Cooldown Test: Click button twice quickly -> toast "Espera 30 segundos..."
5. Task Test: Check Django admin (/admin/django_q/ormq/) -> task queued
6. Security Test: Manually POST to /refrescar-cedula/999/ as non-leader -> 403 response
</verification>

<success_criteria>
- [ ] decorators.py created with leader_or_self_required
- [ ] refresh_cedula_view handles self and referral refresh
- [ ] URL routes for /refrescar-cedula/ and /refrescar-cedula/<user_id>/
- [ ] Refresh button visible only to leaders
- [ ] Button disabled during request with spinner
- [ ] 30-second cooldown enforced server-side
- [ ] Toast notifications for success/warning
- [ ] 403 response for unauthorized refresh attempts
</success_criteria>

<output>
After completion, create `.planning/phases/15-profile-display-refresh/15-02-SUMMARY.md`
</output>
