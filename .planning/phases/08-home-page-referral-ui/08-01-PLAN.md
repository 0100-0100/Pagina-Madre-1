---
phase: 08-home-page-referral-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ___/accounts/views.py
  - ___/accounts/urls.py
  - ___/templates/base.html
  - ___/templates/home.html
autonomous: true

must_haves:
  truths:
    - "User sees their total referral count on home page"
    - "User sees progress bar showing X de Y referidos"
    - "User can copy referral link to clipboard via button"
    - "User sees navigation links to Perfil and Referidos pages"
  artifacts:
    - path: "___/accounts/views.py"
      provides: "home() view with referral context"
      contains: "referral_count"
    - path: "___/accounts/urls.py"
      provides: "Placeholder routes for perfil and referidos"
      contains: "name='perfil'"
    - path: "___/templates/base.html"
      provides: "Bootstrap Icons CDN"
      contains: "bootstrap-icons"
    - path: "___/templates/home.html"
      provides: "Referral stats UI with copy button"
      contains: "copyBtn"
  key_links:
    - from: "___/accounts/views.py"
      to: "___/templates/home.html"
      via: "context variables"
      pattern: "referral_count.*referral_goal.*referral_url"
    - from: "___/templates/home.html"
      to: "navigator.clipboard"
      via: "JavaScript click handler"
      pattern: "navigator\\.clipboard\\.writeText"
---

<objective>
Enhance home page to display referral statistics, provide a copy-to-clipboard button for the referral link, and add navigation links to future pages.

Purpose: Enable users to track their referral progress and easily share their unique referral link with others.

Output: Updated home page with stats card (count + progress bar), share card (copy button), and navbar navigation to Perfil/Referidos.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-home-page-referral-ui/08-CONTEXT.md
@.planning/phases/08-home-page-referral-ui/08-RESEARCH.md

# Relevant source files
@___/accounts/views.py
@___/accounts/urls.py
@___/templates/base.html
@___/templates/home.html
@___/accounts/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update home view and add placeholder routes</name>
  <files>___/accounts/views.py, ___/accounts/urls.py</files>
  <action>
Modify the home() view in views.py to:
1. Count referrals: `referral_count = request.user.referrals.count()`
2. Get referral goal: `referral_goal = request.user.referral_goal`
3. Calculate progress percentage: `progress_percent = min(100, int((referral_count / referral_goal) * 100)) if referral_goal > 0 else 100`
4. Build absolute referral URL: `referral_url = request.build_absolute_uri(reverse('register') + f'?ref={request.user.referral_code}')`
5. Pass all four values to template context along with existing 'user'

Add imports at top: `from django.urls import reverse` (if not present)

In urls.py, add two placeholder routes:
1. `path('perfil/', placeholder_view, name='perfil')`
2. `path('referidos/', placeholder_view, name='referidos')`

Create placeholder_view function that returns HttpResponse("Coming soon", status=200).
Add import: `from django.http import HttpResponse`

Note: The placeholder views exist only to prevent NoReverseMatch errors. They will be replaced in Phases 9 and 10.
  </action>
  <verify>
Run: `python ___/manage.py shell -c "from django.urls import reverse; print(reverse('perfil'), reverse('referidos'))"`
Should print: /perfil/ /referidos/
  </verify>
  <done>
home() view passes referral_count, referral_goal, progress_percent, referral_url to template.
URLs /perfil/ and /referidos/ resolve without error.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Bootstrap Icons CDN and update navbar</name>
  <files>___/templates/base.html, ___/templates/home.html</files>
  <action>
In base.html, add Bootstrap Icons CSS after the Bootstrap CSS link in the head section:
```html
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
      rel="stylesheet"
      integrity="sha384-CK2SzKma4jA5H/MXDUU7i1TqZlCFaD4T01vtyDFvPlD97JQyS+IsSh1nI2EFbpyk"
      crossorigin="anonymous">
```

In home.html, update the navbar section to add Perfil and Referidos links BEFORE the logout button:
```html
<ul class="navbar-nav ms-auto align-items-center">
    <li class="nav-item">
        <a class="nav-link" href="{% url 'perfil' %}">
            <i class="bi bi-person"></i> Perfil
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'referidos' %}">
            <i class="bi bi-people"></i> Referidos
        </a>
    </li>
    <li class="nav-item">
        <form method="post" action="{% url 'logout' %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-light btn-sm ms-2">
                <i class="bi bi-box-arrow-right"></i> Cerrar Sesion
            </button>
        </form>
    </li>
</ul>
```

Remove the existing username display span (lines 15-18 in current home.html) - the welcome card already shows the user's name.
  </action>
  <verify>
Start server: `python ___/manage.py runserver`
Visit http://localhost:8000/ while logged in.
Verify Bootstrap Icons load (check Network tab for bootstrap-icons.min.css 200).
Verify navbar shows: Perfil | Referidos | Cerrar Sesion links.
Click Perfil - should show "Coming soon" text.
Click Referidos - should show "Coming soon" text.
  </verify>
  <done>
Bootstrap Icons CSS loads without errors.
Navbar displays three items with icons: Perfil, Referidos, Cerrar Sesion.
Both navigation links work (show placeholder text).
  </done>
</task>

<task type="auto">
  <name>Task 3: Update home page content with stats and share cards</name>
  <files>___/templates/home.html</files>
  <action>
Replace the content block in home.html with two vertically stacked cards:

**Card 1: Stats Card** (top)
- Large referral count number: `{{ referral_count }}` styled with `display-4 fw-bold text-primary`
- Label: "referidos" below the number
- Bootstrap progress bar showing progress_percent width
- Text: "{{ referral_count }} de {{ referral_goal }} referidos"
- If referral_count == 0, show encouragement: "Comparte tu enlace!"

**Card 2: Share Card** (bottom)
- Hidden input with id="referralUrl" containing `{{ referral_url }}`
- Primary button with id="copyBtn": "Copiar Link de Referido" with clipboard icon
- Toast container positioned top-right for copy feedback

Layout: Use `col-lg-6 col-md-8 col-12 mx-auto` for responsive centering (50-60% width).

Add JavaScript in extra_js block:
```javascript
(function() {
    'use strict';

    const copyBtn = document.getElementById('copyBtn');
    const referralUrl = document.getElementById('referralUrl');
    const toastEl = document.getElementById('copyToast');

    if (copyBtn && referralUrl && toastEl) {
        const toast = new bootstrap.Toast(toastEl, { delay: 3000 });

        copyBtn.addEventListener('click', async function() {
            try {
                await navigator.clipboard.writeText(referralUrl.value);

                // Update button temporarily
                const originalHTML = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="bi bi-check-lg"></i> Copiado!';
                copyBtn.classList.remove('btn-primary');
                copyBtn.classList.add('btn-success');

                // Show toast
                toast.show();

                // Reset after 2 seconds
                setTimeout(() => {
                    copyBtn.innerHTML = originalHTML;
                    copyBtn.classList.remove('btn-success');
                    copyBtn.classList.add('btn-primary');
                }, 2000);

            } catch (err) {
                console.error('Copy failed:', err);
                alert('No se pudo copiar. Tu enlace es: ' + referralUrl.value);
            }
        });
    }
})();
```

Keep the messages display at the top of the content block for Django messages.
  </action>
  <verify>
1. Visit http://localhost:8000/ while logged in
2. Verify stats card shows:
   - Large number (0 or more) for referral count
   - Progress bar with correct fill percentage
   - "X de Y referidos" text
3. Click "Copiar Link de Referido" button:
   - Button should change to green "Copiado!" for 2 seconds
   - Toast should appear top-right: "Enlace copiado al portapapeles"
4. Paste clipboard contents - should be full URL like http://localhost:8000/register/?ref=XXXXXXXX
5. Verify responsive: resize browser, cards should be full-width on mobile
  </verify>
  <done>
Home page displays referral count with progress bar.
Copy button copies full referral URL to clipboard.
Toast notification confirms successful copy.
Button provides visual feedback (color change + text change).
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify against requirements:

| Requirement | Verification |
|-------------|--------------|
| HOME-01 | Home page shows "X referidos" count |
| HOME-02 | Progress bar shows X de Y with correct percentage |
| HOME-03 | Copy button copies full URL (http://localhost:8000/register/?ref=CODE) |
| HOME-04 | Navbar has Perfil and Referidos links that work |

Manual verification:
1. Log in to home page
2. Check referral count matches admin (should be 0 for new user)
3. Click copy button, paste in browser - should load registration page
4. Click Perfil - shows "Coming soon"
5. Click Referidos - shows "Coming soon"
</verification>

<success_criteria>
1. Home page displays referral count number matching `user.referrals.count()`
2. Progress bar percentage = `(count / goal) * 100`, capped at 100%
3. Copy button copies full referral URL to clipboard with toast feedback
4. Navbar has working links to /perfil/ and /referidos/
5. All four HOME requirements (HOME-01 through HOME-04) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/08-home-page-referral-ui/08-01-SUMMARY.md`
</output>
