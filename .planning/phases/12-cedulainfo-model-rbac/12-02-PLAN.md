---
phase: 12-cedulainfo-model-rbac
plan: 02
type: execute
wave: 2
depends_on: [12-01]
files_modified:
  - ___/accounts/models.py
  - ___/accounts/admin.py
  - ___/accounts/migrations/0006_customuser_role.py
autonomous: true

must_haves:
  truths:
    - "CustomUser has role field with USER/LEADER choices"
    - "New users automatically get role=USER"
    - "CedulaInfo is visible in Django admin"
    - "CedulaInfo admin is read-only (no add/change/delete)"
    - "Only superadmin can change user roles"
  artifacts:
    - path: "___/accounts/models.py"
      provides: "Role TextChoices on CustomUser"
      contains: "class Role"
    - path: "___/accounts/admin.py"
      provides: "CedulaInfoAdmin and updated CustomUserAdmin"
      contains: "class CedulaInfoAdmin"
    - path: "___/accounts/migrations/0006_customuser_role.py"
      provides: "Migration for role field"
      contains: "AddField"
  key_links:
    - from: "CedulaInfoAdmin"
      to: "CedulaInfo"
      via: "@admin.register decorator"
      pattern: "@admin\\.register\\(CedulaInfo\\)"
    - from: "CustomUserAdmin.get_readonly_fields"
      to: "role field"
      via: "conditional readonly for non-superusers"
      pattern: "if not request\\.user\\.is_superuser"

requirements_satisfied:
  - DATA-06: CedulaInfo registered in Django admin (read-only display)
  - RBAC-01: Role field added to CustomUser with USER/LEADER choices
  - RBAC-02: Default role is USER for new registrations
  - RBAC-03: Only Django superadmin can change user roles (via admin)
---

<objective>
Add role field to CustomUser and configure Django admin for CedulaInfo (read-only) and role management (superadmin only).

Purpose: Enable USER/LEADER role distinction for future access control, and provide admin visibility into census data without allowing manual edits.

Output: Role field on CustomUser with USER default. CedulaInfo admin with read-only enforcement. CustomUser admin updated with role column and superadmin-only editing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-cedulainfo-model-rbac/12-CONTEXT.md
@.planning/phases/12-cedulainfo-model-rbac/12-RESEARCH.md
@.planning/phases/12-cedulainfo-model-rbac/12-01-SUMMARY.md
@___/accounts/models.py
@___/accounts/admin.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Role field to CustomUser model</name>
  <files>___/accounts/models.py</files>
  <action>
Add Role TextChoices and role field to CustomUser class:

1. Inside CustomUser class, add Role TextChoices enum BEFORE the cedula field:

   class Role(models.TextChoices):
       USER = 'USER', 'Usuario'
       LEADER = 'LEADER', 'Lider'

2. Add role field AFTER referral_goal field:

   role = models.CharField(
       max_length=10,
       choices=Role.choices,
       default=Role.USER,
       verbose_name='Rol',
   )

The Role enum goes inside CustomUser class (not at module level) for proper namespacing (CustomUser.Role.USER, CustomUser.Role.LEADER).
  </action>
  <verify>
python ___/manage.py check --verbosity=2 | grep -E "(System check|No issues)"
  </verify>
  <done>
CustomUser.Role enum exists with USER/LEADER choices. role field defined with default=Role.USER.
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate and apply role migration</name>
  <files>___/accounts/migrations/0006_customuser_role.py</files>
  <action>
1. Generate migration:
   python ___/manage.py makemigrations accounts --name customuser_role

2. Review migration to confirm AddField for role with default='USER'

3. Apply migration:
   python ___/manage.py migrate accounts

4. Verify existing users got default role:
   python -c "from ___/accounts.models import CustomUser; print('Users with USER role:', CustomUser.objects.filter(role='USER').count())"
  </action>
  <verify>
python ___/manage.py showmigrations accounts | grep -E "\\[X\\].*0006"
  </verify>
  <done>
Migration 0006_customuser_role applied. All existing users have role='USER'.
  </done>
</task>

<task type="auto">
  <name>Task 3: Configure CedulaInfo and CustomUser admin</name>
  <files>___/accounts/admin.py</files>
  <action>
Update accounts/admin.py with CedulaInfoAdmin and enhanced CustomUserAdmin:

1. Update imports to include CedulaInfo:
   from .models import CustomUser, CedulaInfo

2. Add CedulaInfoAdmin class (read-only) BEFORE CustomUserAdmin:

   @admin.register(CedulaInfo)
   class CedulaInfoAdmin(admin.ModelAdmin):
       """Read-only admin for CedulaInfo - data comes from scraping only."""

       list_display = (
           'user',
           'status',
           'departamento',
           'municipio',
           'puesto',
           'direccion',
           'mesa',
           'novedad',
           'resolucion',
           'fecha_novedad',
           'fetched_at',
           'error_message',
       )
       list_filter = ('status', 'departamento')
       search_fields = (
           'user__cedula',
           'user__nombre_completo',
           'municipio',
           'puesto',
       )
       ordering = ('-fetched_at',)

       def get_readonly_fields(self, request, obj=None):
           """Make all fields read-only."""
           return [f.name for f in self.model._meta.fields]

       def has_add_permission(self, request):
           return False

       def has_change_permission(self, request, obj=None):
           return False

       def has_delete_permission(self, request, obj=None):
           return False

3. Update CustomUserAdmin:
   - Add 'role' to list_display tuple (at the end)
   - Add 'Role' fieldset to fieldsets:
     ('Role', {
         'fields': ('role',),
         'description': 'Solo superadmins pueden cambiar roles',
     }),
   - Override get_readonly_fields to make role read-only for non-superusers:

     def get_readonly_fields(self, request, obj=None):
         """Make role read-only for non-superusers."""
         readonly = list(self.readonly_fields)
         if not request.user.is_superuser:
             readonly.append('role')
         return readonly
  </action>
  <verify>
python ___/manage.py check --verbosity=2 | grep -E "(System check|No issues)"
python -c "from ___/accounts.admin import CedulaInfoAdmin, CustomUserAdmin; print('Admins imported successfully')"
  </verify>
  <done>
CedulaInfoAdmin registered as read-only. CustomUserAdmin includes role with superadmin-only editing.
  </done>
</task>

</tasks>

<verification>
# Verify Role choices on CustomUser
python -c "
from ___/accounts.models import CustomUser
assert len(CustomUser.Role.choices) == 2, 'Should have 2 role choices'
assert CustomUser.Role.USER == 'USER', 'USER value incorrect'
assert CustomUser.Role.LEADER == 'LEADER', 'LEADER value incorrect'
print('Role choices verified: USER, LEADER')
"

# Verify role field default
python -c "
from ___/accounts.models import CustomUser
role_field = CustomUser._meta.get_field('role')
print(f'Role default: {role_field.default}')
assert role_field.default == 'USER', 'Default should be USER'
print('Role default is USER')
"

# Verify CedulaInfoAdmin is read-only
python -c "
from ___/accounts.admin import CedulaInfoAdmin
from django.test import RequestFactory
admin_instance = CedulaInfoAdmin(model=None, admin_site=None)
class MockRequest: pass
req = MockRequest()
assert admin_instance.has_add_permission(req) == False, 'Should not allow add'
assert admin_instance.has_change_permission(req) == False, 'Should not allow change'
assert admin_instance.has_delete_permission(req) == False, 'Should not allow delete'
print('CedulaInfoAdmin is read-only (no add/change/delete)')
"

# Verify CustomUserAdmin role visibility
python -c "
from ___/accounts.admin import CustomUserAdmin
assert 'role' in CustomUserAdmin.list_display, 'role should be in list_display'
print('Role column visible in CustomUserAdmin list view')
"
</verification>

<success_criteria>
1. CustomUser.Role enum has USER and LEADER choices
2. CustomUser.role field exists with default='USER'
3. Migration 0006_customuser_role applied successfully
4. Existing users have role='USER'
5. CedulaInfoAdmin registered with all 12 display columns
6. CedulaInfoAdmin is read-only (has_add/change/delete_permission return False)
7. CustomUserAdmin shows role in list_display
8. CustomUserAdmin has Role fieldset with description
9. Role field is read-only for non-superusers (get_readonly_fields)
10. Django system check passes
</success_criteria>

<output>
After completion, create `.planning/phases/12-cedulainfo-model-rbac/12-02-SUMMARY.md`
</output>
