---
phase: 12-cedulainfo-model-rbac
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ___/accounts/models.py
  - ___/accounts/migrations/0005_cedulainfo.py
autonomous: true

must_haves:
  truths:
    - "CedulaInfo model exists with all 9 status choices"
    - "CedulaInfo has OneToOne link to CustomUser"
    - "Voting location fields are present (departamento, municipio, puesto, direccion, mesa)"
    - "Cancelled cedula fields are present (novedad, resolucion, fecha_novedad)"
    - "Metadata fields are present (fetched_at, error_message, raw_response)"
  artifacts:
    - path: "___/accounts/models.py"
      provides: "CedulaInfo model with Status TextChoices"
      contains: "class CedulaInfo"
    - path: "___/accounts/migrations/0005_cedulainfo.py"
      provides: "Migration for CedulaInfo model"
      contains: "CreateModel"
  key_links:
    - from: "CedulaInfo.user"
      to: "CustomUser"
      via: "OneToOneField with settings.AUTH_USER_MODEL"
      pattern: "models\\.OneToOneField.*AUTH_USER_MODEL"

requirements_satisfied:
  - DATA-01: CedulaInfo model created with OneToOne link to CustomUser
  - DATA-02: Status field with all 9 choices
  - DATA-03: Voting location fields
  - DATA-04: Cancelled fields
  - DATA-05: Metadata fields
---

<objective>
Create CedulaInfo model to store census/voting data fetched from Registraduria.

Purpose: Provide data structure for storing scraped voting location data with status tracking for all possible outcomes (active, cancelled, not found, error states).

Output: CedulaInfo model with 9 status choices, voting location fields, cancelled cedula fields, and metadata fields. Migration applied successfully.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-cedulainfo-model-rbac/12-CONTEXT.md
@.planning/phases/12-cedulainfo-model-rbac/12-RESEARCH.md
@___/accounts/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CedulaInfo model to accounts/models.py</name>
  <files>___/accounts/models.py</files>
  <action>
Add CedulaInfo model AFTER CustomUser class in accounts/models.py:

1. Import settings at top: `from django.conf import settings`

2. Add CedulaInfo class with:
   - Status TextChoices enum with 9 values:
     - PENDING = 'PENDING', 'Pendiente'
     - PROCESSING = 'PROCESSING', 'Procesando'
     - ACTIVE = 'ACTIVE', 'Activo'
     - NOT_FOUND = 'NOT_FOUND', 'No encontrado'
     - CANCELLED_DECEASED = 'CANCELLED_DECEASED', 'Cancelada - Fallecido'
     - CANCELLED_OTHER = 'CANCELLED_OTHER', 'Cancelada - Otro'
     - ERROR = 'ERROR', 'Error'
     - TIMEOUT = 'TIMEOUT', 'Timeout'
     - BLOCKED = 'BLOCKED', 'Bloqueado'

   - user field: OneToOneField to settings.AUTH_USER_MODEL with:
     - on_delete=models.CASCADE
     - related_name='cedula_info'
     - verbose_name='Usuario'

   - status field: CharField max_length=20, choices=Status.choices, default=Status.PENDING, verbose_name='Estado'

   - Voting location fields (all CharField, blank=True):
     - departamento (max_length=100, verbose_name='Departamento')
     - municipio (max_length=100, verbose_name='Municipio')
     - puesto (max_length=200, verbose_name='Puesto de votacion')
     - direccion (max_length=300, verbose_name='Direccion')
     - mesa (max_length=20, verbose_name='Mesa')

   - Cancelled cedula fields (all CharField, blank=True):
     - novedad (max_length=200, verbose_name='Novedad')
     - resolucion (max_length=100, verbose_name='Resolucion')
     - fecha_novedad (max_length=50, verbose_name='Fecha de novedad')

   - Metadata fields:
     - fetched_at: DateTimeField(null=True, blank=True, verbose_name='Fecha de consulta')
     - error_message: TextField(blank=True, verbose_name='Mensaje de error')
     - raw_response: TextField(blank=True, verbose_name='Respuesta cruda', help_text='HTML/JSON response from Registraduria for debugging')

   - Meta class:
     - verbose_name = 'Informacion de cedula'
     - verbose_name_plural = 'Informacion de cedulas'

   - __str__ method: return f"{self.user.cedula} - {self.get_status_display()}"

Use Spanish verbose_names for all fields as shown above.
  </action>
  <verify>
python ___/manage.py check --verbosity=2 | grep -E "(System check|No issues)"
  </verify>
  <done>
CedulaInfo model exists in models.py with all fields defined. Django system check passes with no issues.
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate and apply CedulaInfo migration</name>
  <files>___/accounts/migrations/0005_cedulainfo.py</files>
  <action>
1. Generate migration:
   python ___/manage.py makemigrations accounts --name cedulainfo

2. Review generated migration file to confirm:
   - CreateModel operation for CedulaInfo
   - All 13 fields present (user, status, 5 voting location, 3 cancelled, 3 metadata)
   - OneToOneField correctly references settings.AUTH_USER_MODEL

3. Apply migration:
   python ___/manage.py migrate accounts

4. Verify migration applied:
   python ___/manage.py showmigrations accounts
  </action>
  <verify>
python ___/manage.py showmigrations accounts | grep -E "\\[X\\].*0005"
python -c "from ___/accounts.models import CedulaInfo; print('Status choices:', len(CedulaInfo.Status.choices))"
  </verify>
  <done>
Migration 0005_cedulainfo applied. CedulaInfo model importable with 9 status choices.
  </done>
</task>

</tasks>

<verification>
# Verify CedulaInfo model structure
python -c "
from ___/accounts.models import CedulaInfo
# Check status choices count
assert len(CedulaInfo.Status.choices) == 9, 'Should have 9 status choices'
# Check all status values exist
statuses = ['PENDING', 'PROCESSING', 'ACTIVE', 'NOT_FOUND', 'CANCELLED_DECEASED', 'CANCELLED_OTHER', 'ERROR', 'TIMEOUT', 'BLOCKED']
for s in statuses:
    assert hasattr(CedulaInfo.Status, s), f'Missing status: {s}'
print('All 9 status choices verified')
"

# Verify model fields
python -c "
from ___/accounts.models import CedulaInfo
fields = [f.name for f in CedulaInfo._meta.get_fields()]
required = ['user', 'status', 'departamento', 'municipio', 'puesto', 'direccion', 'mesa', 'novedad', 'resolucion', 'fecha_novedad', 'fetched_at', 'error_message', 'raw_response']
for r in required:
    assert r in fields, f'Missing field: {r}'
print('All required fields present')
"

# Verify OneToOne relationship
python -c "
from ___/accounts.models import CedulaInfo, CustomUser
user_field = CedulaInfo._meta.get_field('user')
print(f'User field type: {type(user_field).__name__}')
print(f'Related name: {user_field.remote_field.related_name}')
assert user_field.remote_field.related_name == 'cedula_info'
print('OneToOne relationship verified')
"
</verification>

<success_criteria>
1. CedulaInfo model exists in ___/accounts/models.py with Status TextChoices enum
2. All 9 status choices present: PENDING, PROCESSING, ACTIVE, NOT_FOUND, CANCELLED_DECEASED, CANCELLED_OTHER, ERROR, TIMEOUT, BLOCKED
3. OneToOneField links to CustomUser via settings.AUTH_USER_MODEL
4. 5 voting location fields present and blank=True
5. 3 cancelled cedula fields present and blank=True
6. 3 metadata fields present (fetched_at nullable, others blank)
7. Migration 0005_cedulainfo created and applied
8. Django system check passes
</success_criteria>

<output>
After completion, create `.planning/phases/12-cedulainfo-model-rbac/12-01-SUMMARY.md`
</output>
