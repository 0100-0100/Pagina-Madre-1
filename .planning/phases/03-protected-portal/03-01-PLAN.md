---
phase: 03-protected-portal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ___/accounts/views.py
  - ___/accounts/urls.py
  - ___/templates/home.html
  - ___/___/settings.py
autonomous: true

must_haves:
  truths:
    - "User sees home page immediately after successful login"
    - "Home page displays user's nombre_completo or cedula"
    - "User can click logout button to return to login page"
    - "Unauthenticated access to home page redirects to login"
  artifacts:
    - path: "___/accounts/views.py"
      provides: "home() view function"
      min_lines: 45
      exports: ["home"]
    - path: "___/templates/home.html"
      provides: "Home page template with logout button"
      min_lines: 25
      contains: "Welcome"
    - path: "___/accounts/urls.py"
      provides: "Root URL route to home view"
      contains: "path('', home, name='home')"
  key_links:
    - from: "___/___/settings.py"
      to: "LOGIN_REDIRECT_URL"
      via: "setting value"
      pattern: "LOGIN_REDIRECT_URL = '/'"
    - from: "___/templates/home.html"
      to: "/logout/"
      via: "POST form action"
      pattern: "action=\"{% url 'logout' %}\""
    - from: "___/templates/home.html"
      to: "user.nombre_completo"
      via: "template variable"
      pattern: "{{ user\\.nombre_completo|default:user\\.username }}"
---

<objective>
Create protected home page as post-login landing with user info and logout functionality.

Purpose: Satisfy PAGE-03 requirement - authenticated users need a landing page after login that displays their identity and allows logout.
Output: Working home page at '/' that shows user's name and has functional logout button.
</objective>

<execution_context>
@/Users/Diego.Lopezruiz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Diego.Lopezruiz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/Diego.Lopezruiz/Documents/Repositories/Pagina-Madre-1/.planning/PROJECT.md
@/Users/Diego.Lopezruiz/Documents/Repositories/Pagina-Madre-1/.planning/ROADMAP.md
@/Users/Diego.Lopezruiz/Documents/Repositories/Pagina-Madre-1/.planning/STATE.md

# Existing code context
@/Users/Diego.Lopezruiz/Documents/Repositories/Pagina-Madre-1/___/accounts/models.py
@/Users/Diego.Lopezruiz/Documents/Repositories/Pagina-Madre-1/___/accounts/views.py
@/Users/Diego.Lopezruiz/Documents/Repositories/Pagina-Madre-1/___/accounts/urls.py
@/Users/Diego.Lopezruiz/Documents/Repositories/Pagina-Madre-1/___/___/settings.py
@/Users/Diego.Lopezruiz/Documents/Repositories/Pagina-Madre-1/___/templates/registration/login.html

# Prior phase summaries
@/Users/Diego.Lopezruiz/Documents/Repositories/Pagina-Madre-1/.planning/phases/02-authentication-system/02-01-SUMMARY.md
@/Users/Diego.Lopezruiz/Documents/Repositories/Pagina-Madre-1/.planning/phases/02-authentication-system/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create home view and URL route</name>
  <files>___/accounts/views.py, ___/accounts/urls.py</files>
  <action>
  Add home view function to accounts/views.py:
  - Create home(request) function decorated with @login_required (NOT using LoginRequiredMiddleware exemptions - this is the protected page)
  - Function renders 'home.html' template
  - Pass user object to template context (available as request.user)

  Add URL route to accounts/urls.py:
  - Import home view: from .views import home
  - Add path('', home, name='home') at the TOP of urlpatterns (before register, login, logout)
  - This makes home page the root URL '/'

  Note: LoginRequiredMiddleware already protects all routes. The @login_required decorator is defensive but not strictly required. However, use it for explicitness and in case middleware config changes.
  </action>
  <verify>
  grep -A5 "def home" ___/accounts/views.py
  grep "path('', home" ___/accounts/urls.py
  </verify>
  <done>
  home() function exists in views.py with @login_required decorator.
  Root URL route (path('', home, name='home')) exists in urls.py.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create home page template with logout button</name>
  <files>___/templates/home.html</files>
  <action>
  Create home.html template in templates/ directory (NOT in templates/registration/ - this is a main page, not an auth page):

  Structure:
  - HTML5 document with Spanish lang attribute
  - Title: "Home - Pagina Madre"
  - Display welcome message with user's nombre_completo: "Bienvenido, {{ user.nombre_completo }}"
  - If nombre_completo is empty, fallback to username (cedula): {{ user.nombre_completo|default:user.username }}
  - Logout button that POSTs to {% url 'logout' %}
  - Use a FORM with method="post" for logout (not a link - Django LogoutView requires POST for security)
  - Include {% csrf_token %} in logout form

  Keep styling minimal (plain HTML) - consistent with login.html style.

  Reference: login.html shows the project's template style (minimal, no CSS framework).
  </action>
  <verify>
  cat ___/templates/home.html
  grep "nombre_completo" ___/templates/home.html
  grep "csrf_token" ___/templates/home.html
  </verify>
  <done>
  home.html exists in templates/ directory.
  Template displays user.nombre_completo with fallback to user.username.
  Logout button uses POST form with {% csrf_token %}.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update LOGIN_REDIRECT_URL to point to home page</name>
  <files>___/___/settings.py</files>
  <action>
  Update settings.py LOGIN_REDIRECT_URL:
  - Change LOGIN_REDIRECT_URL = '/admin/' to LOGIN_REDIRECT_URL = '/'
  - Remove the comment "# Temporary, will change to '/home/' in Phase 3" (no longer needed)
  - This makes successful login redirect to '/' (the home page root URL)

  Do NOT change:
  - LOGIN_URL = '/login/' (still correct)
  - LOGOUT_REDIRECT_URL = '/login/' (still correct)

  Note: The register() view in accounts/views.py already has fallback logic (tries 'home', falls back to '/admin/'), so it will automatically work once this setting is updated.
  </action>
  <verify>
  grep "LOGIN_REDIRECT_URL" ___/___/settings.py
  </verify>
  <done>
  LOGIN_REDIRECT_URL = '/' in settings.py.
  Comment about "Temporary" removed.
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify the complete flow:

1. Start development server: python ___/manage.py runserver
2. Visit http://127.0.0.1:8000/ (unauthenticated) - should redirect to /login/
3. Register a new user - should redirect to home page at /
4. Verify home page displays "Bienvenido, [nombre_completo]"
5. Click logout button - should redirect to /login/
6. Try visiting http://127.0.0.1:8000/ again - should redirect to /login/ (unauthenticated)

All redirects should happen automatically without manual navigation.
</verification>

<success_criteria>
Phase 3 is complete when:
- [x] Unauthenticated access to / redirects to /login/ (LoginRequiredMiddleware working)
- [x] User logs in and sees home page at / immediately (LOGIN_REDIRECT_URL working)
- [x] Home page displays user's nombre_completo or cedula (template rendering user context)
- [x] User clicks logout button and returns to /login/ (LogoutView + LOGOUT_REDIRECT_URL working)
- [x] PAGE-03 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-protected-portal/03-01-SUMMARY.md` following the summary template.

Include:
- What was built (home view, template, URL route, settings update)
- Key implementation details (nombre_completo fallback, POST logout form)
- Test results (full auth flow verification)
- Completion of PAGE-03 requirement
</output>
