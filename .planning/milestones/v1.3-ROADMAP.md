# Milestone v1.3: Async Background Jobs

**Status:** SHIPPED 2026-01-22
**Phases:** 11-16
**Total Plans:** 9

## Overview

Add background task processing with web scraping to validate user cédulas against Registraduría's electoral census. Six phases: Django-Q2 foundation with SQLite WAL mode, CedulaInfo model with RBAC role fields, Playwright headless browser scraper with 2captcha integration, task integration with post_save signals, profile display with refresh buttons, and referidos page census data updates. The system auto-triggers validation on registration and allows manual refresh by leaders.

## Phases

### Phase 11: Django-Q2 Foundation

**Goal**: Background task queue runs reliably with SQLite database.
**Depends on**: Nothing (foundation phase)
**Plans**: 1 plan

Plans:
- [x] 11-01: Install Django-Q2, configure SQLite WAL mode, verify task execution

**Details:**
- Django-Q2 installed with ORM broker configuration (INFRA-01)
- SQLite WAL mode enabled preventing database locking (INFRA-02)
- qcluster process starts and runs correctly (INFRA-03)
- Timeout=120s, retry=180s configured for cedula tasks (INFRA-04)
- Enhanced FailureAdmin with duration and attempt count columns
- echo_test task verified with success=True result

---

### Phase 12: CedulaInfo Model + RBAC

**Goal**: Census data can be stored and roles control access.
**Depends on**: Phase 11 (Django-Q2 migrations complete)
**Plans**: 2 plans

Plans:
- [x] 12-01: Create CedulaInfo model with 9 status choices and all fields
- [x] 12-02: Add role field to CustomUser and configure admin

**Details:**
- CedulaInfo model with Status TextChoices enum (9 statuses covering full lifecycle)
- OneToOneField link to CustomUser via settings.AUTH_USER_MODEL
- 5 voting location fields, 3 cancelled cedula fields, 3 metadata fields
- Role TextChoices enum with USER/LEADER choices nested in CustomUser class
- CedulaInfo admin is fully read-only, role field is superadmin-only

---

### Phase 13: Playwright Scraper

**Goal**: Scraper retrieves census data from Registraduría for any cédula.
**Depends on**: Phase 12 (CedulaInfo model exists to store results)
**Plans**: 2 plans

Plans:
- [x] 13-01: Install Playwright with Chromium, create browser singleton
- [x] 13-02: Implement scraper with all response types and rate limiting

**Details:**
- Playwright 1.57.0 installed with Chromium browser binary
- Browser singleton pattern with context-per-scrape isolation
- Response type detection for 7 status codes (found, cancelled, not_found, blocked, timeout, network_error, parse_error)
- Rate limiting enforcing 5 seconds between requests
- 2captcha integration for automated reCAPTCHA solving

---

### Phase 14: Task Integration + Signals

**Goal**: Census lookup auto-triggers on registration and retries on failure.
**Depends on**: Phase 13 (scraper exists)
**Plans**: 1 plan

Plans:
- [x] 14-01: Signal handler, validate_cedula task, exponential backoff retry

**Details:**
- Post-save signal creates CedulaInfo and queues async task on user registration
- validate_cedula task implements exponential backoff retry (60s, 300s, 900s)
- Status handlers correctly map scraper results to CedulaInfo status choices
- transaction.on_commit() for race-condition-free task queuing

---

### Phase 15: Profile Display + Refresh

**Goal**: Users see their census data and leaders can refresh for referrals.
**Depends on**: Phase 14 (tasks populate CedulaInfo)
**Plans**: 2 plans

Plans:
- [x] 15-01: HTMX setup, census section partial, profile display with polling
- [x] 15-02: Leader refresh button, RBAC decorator, rate limiting

**Details:**
- HTMX 2.0.4 loaded globally for dynamic updates
- Census section partial handling all 9 CedulaInfo status states
- Conditional HTMX polling that stops on final states (5-second interval)
- leader_or_self_required RBAC decorator
- 30-second server-side cooldown using fetched_at timestamp

---

### Phase 16: Referidos Page Updates

**Goal**: Leaders see census data for all their referred users with live updates.
**Depends on**: Phase 15 (census display and RBAC complete)
**Plans**: 1 plan

Plans:
- [x] 16-01: Referidos page with census status, expandable rows, filters, bulk refresh

**Details:**
- Census status visibility for all referrals with color-coded badges
- Expandable rows showing full voting location or error details
- Filter tabs (All/Pendientes/Encontrados/Errores) with client-side filtering
- Sortable columns (name, cedula, date, status)
- Bulk refresh with checkbox selection (max 10 per request)

---

## Milestone Summary

**Key Decisions:**
- ORM broker with SQLite for <100 users scenario
- Single worker (workers=1) critical for SQLite write safety
- WAL mode via connection_created signal for all connections
- Browser singleton with lazy initialization for Playwright
- Fresh context per scrape with cleanup in finally block
- 2captcha for reCAPTCHA solving (fully automated)
- dispatch_uid for signal deduplication
- schedule() with schedule_type='O' for one-time delayed retry
- HTMX 2.0.4 with conditional polling via data attributes
- leader_or_self_required decorator for RBAC checks
- 30-second server-side cooldown using fetched_at timestamp
- Checkbox visibility only for non-final statuses

**Issues Resolved:**
- Bug #1: TemplateSyntaxError on /referidos/ (invalid {% with %} boolean)
- Bug #2: Django admin AttributeError (Python 3.14 compatibility)
- Bug #3: Tasks fail "Function not defined" (multiprocessing fork method)
- Bug #4: Remote client task not queued (signal error handling)
- Bug #5: UI perpetual loading (stale status detection)
- Bug #6: Referidos no auto-update (HTMX batch polling)
- Bug #7: OOB swap broken (template wrapper for <tr> elements)
- Bug #8: Registration tasks fail (multiprocessing placement)
- Bug #9: Bulk refresh fails (zombie qcluster cleanup)

**Tech Debt:**
- Per-referral refresh button returns wrong template (non-blocking)
- NOT_FOUND cedulas can be selected for bulk refresh (enhancement)

---

*For current project status, see .planning/PROJECT.md*
